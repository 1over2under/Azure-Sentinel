{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "location": {
          "defaultValue": "[resourceGroup().location]",
          "minLength": 1,
          "type": "String",
          "metadata": {
              "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
          }
      },
      "workspace-location": {
          "defaultValue": "",
          "type": "String",
          "metadata": {
              "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
          }
      },
      "workspace": {
          "defaultValue": "",
          "type": "String",
          "metadata": {
              "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
          }
      },
      "resourceGroupName": {
          "defaultValue": "[resourceGroup().name]",
          "type": "String",
          "metadata": {
              "description": "resource group name where Microsoft Sentinel is setup"
          }
      },
      "subscription": {
          "defaultValue": "[last(split(subscription().id, '/'))]",
          "type": "String",
          "metadata": {
              "description": "subscription id where Microsoft Sentinel is setup"
          }
      }
  },
  "variables": {
      "email": "support@microsoft.com",
      "_email": "[variables('email')]",
      "_solutionName": "SAP LogServ (RISE)",
      "_solutionVersion": "1.0.9",
      "solutionId": "microsoftazuresentinel.sap_logserv",
      "_solutionId": "[variables('solutionId')]",
      "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
      "dataConnectorCCPVersion": "1.0.9",
      "_dataConnectorContentIdConnectorDefinition1": "SAPLogServ",
      "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "_dataConnectorContentIdConnections1": "SAPLogServConnections",
      "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
      "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
      "blanks": "[replace('b', 'b', '')]",
      "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]",
      "_dataConnectorLogAnalyticsTableIdLogServ": "LogServ_CL"
  },
  "resources": [
      {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2020-10-01",
          "name": "pid-8bea2c69-cff4-4877-834d-31479889506b-partnercenter",
          "properties": {
              "mode": "Incremental",
              "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
              }
          }
      },
      {
          "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
          "apiVersion": "2023-04-01-preview",
          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
          "location": "[parameters('workspace-location')]",
          "dependsOn": [
              "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
          ],
          "properties": {
              "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
              "displayName": "SAP LogServ (RISE), S/4HANA Cloud private edition",
              "contentKind": "DataConnector",
              "mainTemplate": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "[variables('dataConnectorCCPVersion')]",
                  "parameters": {},
                  "variables": {},
                  "resources": [
                      {
                          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
                          "apiVersion": "2022-09-01-preview",
                          "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
                          "location": "[parameters('workspace-location')]",
                          "kind": "Customizable",
                          "properties": {
                              "connectorUiConfig": {
                                  "id": "SAPLogServ",
                                  "title": "SAP LogServ (RISE), S/4HANA Cloud private edition",
                                  "publisher": "SAP SE",
                                  "logo": "SapLogo.svg",
                                  "descriptionMarkdown": "SAP LogServ is an SAP Enterprise Cloud Services (ECS) service aimed at collection, storage, forwarding and access of logs. LogServ centralizes the logs from all systems, applications, and ECS services used by a registered customer. <br> Main Features include:<br>Near Realtime Log Collection: With ability to integrate into Microsoft Sentinel as SIEM solution.<br>LogServ complements the existing SAP application layer threat monitoring and detections in Sentinel with the log types owned by SAP ECS as the system provider. This includes logs like: SAP Security Audit Log (AS ABAP), HANA database, AS JAVA, ICM, SAP Web Dispatcher, SAP Cloud Connector, OS, SAP Gateway, 3rd party Database, Network, DNS, Proxy, Firewall",
                                  "graphQueriesTableName": "LogServ_CL",
                                  "graphQueries": [
                                      {
                                          "metricName": "Total events received",
                                          "legend": "SAP_SID",
                                          "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
                                      }
                                  ],
                                  "sampleQueries": [
                                      {
                                          "description": "Get Sample Events",
                                          "query": "{{graphQueriesTableName}}\n | take 10"
                                      }
                                  ],
                                  "dataTypes": [
                                      {
                                          "name": "{{graphQueriesTableName}}",
                                          "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | where name_s == \"no data test\" | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                                      }
                                  ],
                                  "connectivityCriteria": [
                                      {
                                          "type": "HasDataConnectors"
                                      }
                                  ],
                                  "availability": {
                                      "isPreview": true
                                  },
                                  "permissions": {
                                      "resourceProvider": [
                                          {
                                              "provider": "Microsoft.OperationalInsights/workspaces",
                                              "permissionsDisplayText": "Read and Write permissions are required.",
                                              "providerDisplayName": "Workspace",
                                              "scope": "Workspace",
                                              "requiredPermissions": {
                                                  "write": true,
                                                  "read": true,
                                                  "delete": true
                                              }
                                          },
                                          {
                                              "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                                              "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                                              "providerDisplayName": "Keys",
                                              "scope": "Workspace",
                                              "requiredPermissions": {
                                                  "action": true
                                              }
                                          }
                                      ],
                                      "customs": [
                                          {
                                              "name": "Microsoft Entra",
                                              "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                                          },
                                          {
                                              "name": "Microsoft Azure",
                                              "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
                                          }
                                      ]
                                  },
                                  "instructionSteps": [
                                      {
                                          "title": "1. Create ARM Resources and Provide the Required Permissions",
                                          "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
                                          "instructions": [
                                              {
                                                  "type": "Markdown",
                                                  "parameters": {
                                                      "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                                                  }
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Deploy push connector resources",
                                                      "applicationDisplayName": "SAP LogServ push to Sentinel"
                                                  },
                                                  "type": "DeployPushConnectorButton_test"
                                              }
                                          ]
                                      },
                                      {
                                          "title": "2. Maintain the data collection endpoint details and authentication info in SAP LogServ",
                                          "description": "Share the data collection endpoint URL and authentication info with the SAP LogServ administrator to configure the SAP LogServ to send data to the data collection endpoint.",
                                          "instructions": [
                                              {
                                                  "parameters": {
                                                      "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                                                      "fillWith": [
                                                          "TenantId"
                                                      ]
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Entra Application ID",
                                                      "fillWith": [
                                                          "ApplicationId"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the Application ID"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Entra Application Secret",
                                                      "fillWith": [
                                                          "ApplicationSecret"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the Application Secret"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                                                      "fillWith": [
                                                          "DataCollectionEndpoint"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the DCE URI"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "DCR Immutable ID",
                                                      "fillWith": [
                                                          "DataCollectionRuleId"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the DCR ID"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                  "label": "Stream 1 ID",
                                                  "value": "Custom-LogServ_CL"
                                                  },
                                                  "type": "CopyableLabel"
                                              }
                                          ]
                                      }
                                  ]
                              }
                          }
                      },
                      {
                          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
                          "apiVersion": "2022-01-01-preview",
                          "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                          "properties": {
                              "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                              "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                              "kind": "DataConnector",
                              "version": "[variables('dataConnectorCCPVersion')]",
                              "source": {
                                  "sourceId": "[variables('_solutionId')]",
                                  "name": "[variables('_solutionName')]",
                                  "kind": "Solution"
                              },
                              "author": {
                                  "name": "SAP SE",
                                  "email": "[variables('_email')]"
                              },
                              "support": {
                                  "tier": "Partner",
                                  "name": "SAP SE",
                                  "email": "support@sap.com",
                                  "link": "https://me.sap.com/"
                              },
                              "dependencies": {
                                  "criteria": [
                                      {
                                          "version": "[variables('dataConnectorCCPVersion')]",
                                          "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                                          "kind": "ResourcesDataConnector"
                                      }
                                  ]
                              }
                          }
                      },
                      {
                          "name": "SAPLogServ-DCR",
                          "apiVersion": "2022-06-01",
                          "type": "Microsoft.Insights/dataCollectionRules",
                          "location": "[parameters('workspace-location')]",
                          "kind": "[variables('blanks')]",
                          "properties": {
                              "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                              "streamDeclarations": {
                                  "Custom-LogServ_CL": {
                                      "columns": [
                                          {
                                              "name": "TimeGenerated",
                                              "type": "datetime"
                                          },
                                          {
                                              "name": "_raw",
                                              "type": "string"
                                          },
                                          {
                                              "name": "_time",
                                              "type": "real"
                                          },
                                          {
                                              "name": "source",
                                              "type": "string"
                                          },
                                          {
                                              "name": "host",
                                              "type": "string"
                                          },
                                          {
                                              "name": "sourcetype",
                                              "type": "string"
                                          },
                                          {
                                              "name": "index",
                                              "type": "string"
                                          },
                                          {
                                              "name": "cribl_breaker",
                                              "type": "string"
                                          },
                                          {
                                              "name": "test",
                                              "type": "dynamic"
                                          },
                                          {
                                              "name": "test1",
                                              "type": "dynamic"
                                          },
                                          {
                                              "name": "region",
                                              "type": "string"
                                          },
                                          {
                                              "name": "clz_dir",
                                              "type": "string"
                                          },
                                          {
                                              "name": "clz_subdir",
                                              "type": "string"
                                          },
                                          {
                                              "name": "cribl_pipe",
                                              "type": "string"
                                          }
                                      ]
                                  }
                              },
                              "destinations": {
                                  "logAnalytics": [
                                      {
                                          "workspaceResourceId": "[variables('workspaceResourceId')]",
                                          "name": "clv2ws1"
                                      }
                                  ]
                              },
                              "dataFlows": [
                                  {
                                      "streams": [
                                          "Custom-LogServ_CL"
                                      ],
                                      "destinations": [
                                          "clv2ws1"
                                      ],
                                      "transformKql": "let fromUnixTime = (t: real) { \n    datetime(1970-01-01) + t * 1sec \n};\nsource\n| extend TimeGenerated = fromUnixTime(_time)\n| extend Raw = _raw\n| extend UnixTimestamp =_time\n| project-away  _raw, _time\n",
                                      "outputStream": "Custom-LogServ_CL"
                                  }
                              ]
                          }
                      },
                      {
                          "name": "[variables('_dataConnectorLogAnalyticsTableIdLogServ')]",
                          "apiVersion": "2021-03-01-privatepreview",
                          "type": "Microsoft.OperationalInsights/workspaces/tables",
                          "location": "[parameters('workspace-location')]",
                          "kind": null,
                          "properties": {
                              "schema": {
                                  "name": "[variables('_dataConnectorLogAnalyticsTableIdLogServ')]",
                                  "columns": [
                                      {
                                          "name": "TimeGenerated",
                                          "type": "datetime"
                                      },
                                      {
                                          "name": "clz_dir",
                                          "type": "string"
                                      },
                                      {
                                          "name": "clz_subdir",
                                          "type": "string"
                                      },
                                      {
                                          "name": "cribl_breaker",
                                          "type": "string"
                                      },
                                      {
                                          "name": "cribl_pipe",
                                          "type": "string"
                                      },
                                      {
                                          "name": "host",
                                          "type": "string"
                                      },
                                      {
                                          "name": "index",
                                          "type": "string"
                                      },
                                      {
                                          "name": "region",
                                          "type": "string"
                                      },
                                      {
                                          "name": "source",
                                          "type": "string"
                                      },
                                      {
                                          "name": "sourcetype",
                                          "type": "string"
                                      },
                                      {
                                          "name": "test",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "test1",
                                          "type": "dynamic"
                                      },
                                      {
                                          "name": "Raw",
                                          "type": "string"
                                      },
                                      {
                                          "name": "UnixTimestamp",
                                          "type": "real"
                                      }
                                      ]
                              }
                          }
                      }
                  ]
              },
              "packageKind": "Solution",
              "packageVersion": "[variables('_solutionVersion')]",
              "packageName": "[variables('_solutionName')]",
              "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
              "packageId": "[variables('_solutionId')]",
              "contentSchemaVersion": "3.0.0",
              "version": "[variables('dataConnectorCCPVersion')]"
          }
      },
      {
          "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
          "apiVersion": "2022-09-01-preview",
          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
          "location": "[parameters('workspace-location')]",
          "kind": "Customizable",
          "properties": {
              "connectorUiConfig": {
                  "id": "SAPLogServ",
                  "title": "SAP LogServ (RISE), S/4HANA Cloud private edition",
                  "publisher": "SAP SE",
                  "logo": "SapLogo.svg",
                  "descriptionMarkdown": "SAP LogServ is an SAP Enterprise Cloud Services (ECS) service aimed at collection, storage, forwarding and access of logs. LogServ centralizes the logs from all systems, applications, and ECS services used by a registered customer. <br> Main Features include:<br>Near Realtime Log Collection: With ability to integrate into Microsoft Sentinel as SIEM solution.<br>LogServ complements the existing SAP application layer threat monitoring and detections in Sentinel with the log types owned by SAP ECS as the system provider. This includes logs like: SAP Security Audit Log (AS ABAP), HANA database, AS JAVA, ICM, SAP Web Dispatcher, SAP Cloud Connector, OS, SAP Gateway, 3rd party Database, Network, DNS, Proxy, Firewall",
                  "graphQueriesTableName": "LogServ_CL",
                  "graphQueries": [
                      {
                          "metricName": "Total events received",
                          "legend": "SAP_SID",
                          "baseQuery": "{{graphQueriesTableName}} | project TimeGenerated, SAP_SID= SystemUniqueId"
                      }
                  ],
                  "sampleQueries": [
                      {
                          "description": "Get Sample Events",
                          "query": "{{graphQueriesTableName}}\n | take 10"
                      }
                  ],
                  "dataTypes": [
                      {
                          "name": "{{graphQueriesTableName}}",
                          "lastDataReceivedQuery": "{{graphQueriesTableName}}\n | where TimeGenerated > ago(12h) | where name_s == \"no data test\" | summarize Time = max(TimeGenerated)\n | where isnotempty(Time)"
                      }
                  ],
                  "connectivityCriteria": [
                      {
                          "type": "HasDataConnectors"
                      }
                  ],
                  "availability": {
                      "isPreview": true
                  },
                  "permissions": {
                      "resourceProvider": [
                          {
                              "provider": "Microsoft.OperationalInsights/workspaces",
                              "permissionsDisplayText": "Read and Write permissions are required.",
                              "providerDisplayName": "Workspace",
                              "scope": "Workspace",
                              "requiredPermissions": {
                                  "write": true,
                                  "read": true,
                                  "delete": true
                              }
                          },
                          {
                              "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                              "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                              "providerDisplayName": "Keys",
                              "scope": "Workspace",
                              "requiredPermissions": {
                                  "action": true
                              }
                          }
                      ],
                      "customs": [
                          {
                              "name": "Microsoft Entra",
                              "description": "Permission to create an app registration in Microsoft Entra ID. Typically requires Entra ID Application Developer role or higher."
                          },
                          {
                              "name": "Microsoft Azure",
                              "description": "Permission to assign Monitoring Metrics Publisher role on data collection rules. Typically requires Azure RBAC Owner or User Access Administrator role."
                          }
                      ]
                  },
                  "instructionSteps": [
                                      {
                                          "title": "1. Create ARM Resources and Provide the Required Permissions",
                                          "description": "We will create data collection rule (DCR) and data collection endpoint (DCE) resources. We will also create a Microsoft Entra app registration and assign the required permissions to it.",
                                          "instructions": [
                                              {
                                                  "type": "Markdown",
                                                  "parameters": {
                                                      "content": "#### Automated deployment of Azure resources\nClicking on \"Deploy push connector resources\" will trigger the creation of DCR and DCE resources.\nIt will then create a Microsoft Entra app registration with client secret and grant permissions on the DCR. This setup enables data to be sent securely to the DCR using a OAuth v2 client credentials."
                                                  }
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Deploy push connector resources",
                                                      "applicationDisplayName": "SAP LogServ push to Sentinel"
                                                  },
                                                  "type": "DeployPushConnectorButton_test"
                                              }
                                          ]
                                      },
                                      {
                                          "title": "2. Maintain the data collection endpoint details and authentication info in SAP LogServ",
                                          "description": "Share the data collection endpoint URL and authentication info with the SAP LogServ administrator to configure the SAP LogServ to send data to the data collection endpoint.",
                                          "instructions": [
                                              {
                                                  "parameters": {
                                                      "label": "Use this value to configure as Tenant ID in the LogIngestionAPI credential.",
                                                      "fillWith": [
                                                          "TenantId"
                                                      ]
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Entra Application ID",
                                                      "fillWith": [
                                                          "ApplicationId"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the Application ID"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Entra Application Secret",
                                                      "fillWith": [
                                                          "ApplicationSecret"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the Application Secret"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "Use this value to configure the LogsIngestionURL parameter when deploying the IFlow.",
                                                      "fillWith": [
                                                          "DataCollectionEndpoint"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the DCE URI"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                      "label": "DCR Immutable ID",
                                                      "fillWith": [
                                                          "DataCollectionRuleId"
                                                      ],
                                                      "placeholder": "Deploy push connector to get the DCR ID"
                                                  },
                                                  "type": "CopyableLabel"
                                              },
                                              {
                                                  "parameters": {
                                                  "label": "Stream 1 ID",
                                                  "value": "Custom-LogServ_CL"
                                                  },
                                                  "type": "CopyableLabel"
                                              }
                                          ]
                                      }
                                  ]
              }
          }
      },
      {
          "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
          "apiVersion": "2022-01-01-preview",
          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
          "properties": {
              "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
              "kind": "DataConnector",
              "version": "[variables('dataConnectorCCPVersion')]",
              "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
              },
              "author": {
                  "name": "SAP SE",
                  "email": "[variables('_email')]"
              },
              "support": {
                  "tier": "Partner",
                  "name": "SAP SE",
                  "email": "support@microsoft.com",
                  "link": "https://me.sap.com/"
              },
              "dependencies": {
                  "criteria": [
                      {
                          "version": "[variables('dataConnectorCCPVersion')]",
                          "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                          "kind": "ResourcesDataConnector"
                      }
                  ]
              }
          }
      },
      {
          "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
          "apiVersion": "2023-04-01-preview",
          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
          "location": "[parameters('workspace-location')]",
          "dependsOn": [
              "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
          ],
          "properties": {
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "displayName": "SAP LogServ (RISE) integration ",
              "contentKind": "ResourcesDataConnector",
              "mainTemplate": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "[variables('dataConnectorCCPVersion')]",
                  "parameters": {
                      "connectorDefinitionName": {
                          "defaultValue": "SAP LogServ (RISE) integration ",
                          "type": "string",
                          "minLength": 1
                      },
                      "workspace": {
                          "defaultValue": "[parameters('workspace')]",
                          "type": "string"
                      },
                      "dcrConfig": {
                          "defaultValue": {
                              "dataCollectionEndpoint": "data collection Endpoint",
                              "dataCollectionRuleImmutableId": "data collection rule immutableId"
                          },
                          "type": "object"
                      },
                      "innerWorkspace": {
                          "defaultValue": "[parameters('workspace')]",
                          "type": "string"
                      },
                      "auth": {
                          "defaultValue": {
                              "appId": "appId",
                              "servicePrincipalId": "servicePrincipalId"
                          },
                          "type": "object"
                      }
                  },
                  "variables": {
                      "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]",
                      "connectorName": "MyPushConnectorName"
                  },
                  "resources": [
                      {
                          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
                          "apiVersion": "2022-01-01-preview",
                          "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
                          "properties": {
                              "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                              "kind": "ResourcesDataConnector",
                              "version": "[variables('dataConnectorCCPVersion')]",
                              "source": {
                                  "sourceId": "[variables('_solutionId')]",
                                  "name": "[variables('_solutionName')]",
                                  "kind": "Solution"
                              },
                              "author": {
                                  "name": "SAP SE",
                                  "email": "[variables('_email')]"
                              },
                              "support": {
                                  "tier": "Partner",
                                  "name": "SAP SE",
                                  "email": "support@microsoft.com",
                                  "link": "https://me.sap.com/"
                              }
                          }
                      },
                      {
                          "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/','Push-',variables('connectorName'))]",
                          "apiVersion": "2022-12-01-preview",
                          "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
                          "location": "[parameters('workspace-location')]",
                          "kind": "Push",
                          "properties": {
                              "connectorDefinitionName": "[[parameters('connectorDefinitionName')]",
                              "dcrConfig": {
                                  "dataCollectionRuleId": "[[parameters('dcrConfig').dataCollectionRuleId]",
                                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]",
                                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                                  "streamName": "SENTINEL_HEALTH"
                              },
                              "auth": {
                                  "type": "Push",
                                  "appId": "[[parameters('auth').appId]",
                                  "servicePrincipalId": "[[parameters('auth').servicePrincipalId]"
                              },
                              "request": {},
                              "response": {
                                  "eventsJsonPaths": [
                                      "$.messages"
                                  ]
                              }
                          }
                      }
                  ]
              },
              "packageKind": "Solution",
              "packageVersion": "[variables('_solutionVersion')]",
              "packageName": "[variables('_solutionName')]",
              "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
              "packageId": "[variables('_solutionId')]",
              "contentSchemaVersion": "3.0.0",
              "version": "[variables('dataConnectorCCPVersion')]"
          }
      },
      {
          "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
          "apiVersion": "2023-04-01-preview",
          "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]",
          "location": "[parameters('workspace-location')]",
          "properties": {
              "version": "1.0.9",
              "kind": "Solution",
              "contentSchemaVersion": "3.0.0",
              "displayName": "SAP LogServ (RISE)",
              "publisherDisplayName": "SAP Enterprise Cloud Services (ECS), SAP SE",
              "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>SAP is synonymous with enterprise business. It drives multiple business applications and is the custodian for massive amounts of critical, sensitive data. SAP systems are growing in complexity as organizations expand beyond the base capabilities. This growth causes security risk to rise and allows threats to emerge across modules, so threat correlation is an important part of ensuring SAP security. The Microsoft Sentinel Continuous Threat Monitoring for SAP provides comprehensive and continuous threat detection and analytics, effectively identifying real threats and malicious behaviours. Microsoft Sentinel has built-in API connectors to natively collect transaction logs necessary for monitoring SAP and includes out of the box security content (detections, dashboard) for securing SAP NetWeaver system in Azure and outside of Azure as well. The Microsoft Sentinel solution for SAP® applications is SAP® Certified for Integration with RISE with SAP, S/4HANA Cloud and SAP NetWeaver.</p>\n<p><strong>Data Connectors:</strong> 1, <strong>Parsers:</strong> 2</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
              "contentKind": "Solution",
              "contentProductId": "[variables('_solutioncontentProductId')]",
              "id": "[variables('_solutioncontentProductId')]",
              "icon": "<img src=\"https://store-images.s-microsoft.com/image/apps.34104.ee2d31a6-a2e0-4211-aa4a-6c9256ad6fc3.6f2e173b-d2d4-4e34-9e50-f9bee1dcd1c1.42c18ca4-8388-413d-b4ee-37df356efe27\" width=\"75px\" height=\"75px\">",
              "contentId": "[variables('_solutionId')]",
              "parentId": "[variables('_solutionId')]",
              "source": {
                  "kind": "Solution",
                  "name": "SAP LogServ",
                  "sourceId": "[variables('_solutionId')]"
              },
              "author": {
                  "name": "SAP SE",
                  "email": "[variables('_email')]"
              },
              "support": {
                  "name": "SAP SE",
                  "email": "support@sap.com",
                  "tier": "Partner",
                  "link": "https://me.sap.com/"
              },
              "dependencies": {
                  "operator": "AND",
                  "criteria": [
                      {
                          "kind": "DataConnector",
                          "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                          "version": "[variables('dataConnectorCCPVersion')]"
                      }
                  ]
              },
              "firstPublishDate": "2025-01-01",
              "providers": [
                  "Microsoft"
              ],
              "categories": {
                  "domains": [
                      "Security - Threat Protection",
                      "Identity"
                  ]
              }
          }
      }
  ],
  "outputs": {}
}