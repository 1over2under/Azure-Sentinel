[
    {
        "name": "GCPCloudMonitoringPolling{{copyIndex()}}",
        "apiVersion": "2023-02-01-preview",
        "type": "Microsoft.SecurityInsights/dataConnectors",
        "location": "{{location}}",
        "kind": "RestApiPoller",
        "copy": {
				"name": "gcpCopy",
				"count": "length({{metricNamesArray}})"
			  },
        "properties": {
            "connectorDefinitionName": "GCPMonitorCCPDefinition",
            "dcrConfig": {
                "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
                "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}",
                "streamName": "Custom-GCPMonitor"
            },
            "dataType": "GCP_MONITORINGV2_CL",
            "addOnAttributes": {
                "metrictype": "[[parameters('metrictype')]",
                "projectid": "[[parameters('projectid')]"
            },
            "response": {
                "eventsJsonPaths": [
                    "$.timeSeries"
                ],
                "format": "json"
            },
            "paging": {
                "pagingType": "NextPageToken",
                "nextPageTokenJsonPath": "$.nextPageToken",
                "pageSize": 100,
                "PageSizeParaName": "pageSize",
                "PageTokenParaName": "pageToken",
                "NextPageParaName": "pageToken"
            },
            "auth": {
                "type": "OAuth2",
                "IsClientSecretInHeader": "true",
                "IsCredentialsInHeaders": "true",
                "ClientSecret": "{{clientSecret}}",
                "ClientId": "{{clientId}}",
                "AuthorizationCode": "{{authorizationCode}}",
                "GrantType": "authorization_code",
                "TokenEndpoint": "https://oauth2.googleapis.com/token",
                "tokenEndpointHeaders": {
                    "Accept": "application/json",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                "authorizationEndpoint": "https://accounts.google.com/o/oauth2/auth",
                "authorizationEndpointQueryParameters": {
                    "prompt": "consent",
                    "access_type": "offline"
                },
                "scope": "https://www.googleapis.com/auth/monitoring.read",
                "redirectUri": "https://portal.azure.com/TokenAuthorize/ExtensionName/Microsoft_Azure_Security_Insights"
            },
            "request": {
                "apiEndpoint": "[[concat('https://monitoring.googleapis.com/v3/projects/',parameters('projectid'),'/timeSeries?filter=metric.type=\"',trim(variables('metricNamesArray')[copyIndex()]),'\"')]",
                "httpMethod": "GET",
                "queryParameters": {
                    "interval.startTime": "{_QueryWindowStartTime}",
                    "interval.endTime": "{_QueryWindowEndTime}"
                },
                "queryWindowInMin": 10,
                "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                "rateLimitQPS": 10,
                "retryCount": 3,
                "timeoutInSeconds": 60,
                "headers": {
                    "Accept": "application/json"
                }
            },
            "isActive": true
        }
    }
]
