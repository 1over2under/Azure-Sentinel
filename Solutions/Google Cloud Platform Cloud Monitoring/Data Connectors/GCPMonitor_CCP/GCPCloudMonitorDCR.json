{
    "name": "GCPMonitorDCR",
    "apiVersion": "2022-06-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "{{location}}",
    "properties": {
        "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
        "streamDeclarations": {
            "Custom-GCPMonitor": {
                "columns": [
                    {
                        "name": "metric",
                        "type": "dynamic"
                    },
                    {
                        "name": "resource",
                        "type": "dynamic"
                    },
                    {
                        "name":"metricKind",
                        "type": "string"
                    },
                    {
                        "name":"valueType",
                        "type": "string"
                    },
                    {
                        "name": "points",
                        "type": "dynamic"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "{{workspaceResourceId}}",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-GCPMonitor"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "source | extend TimeGenerated = now() | extend Metric = metric | extend MetricLabelsStorageType = tostring(metric.labels.storage_type) | extend MetricLabelsInstanceName = tostring(metric.labels.instance_name) | extend MetricLabelsDeviceName = tostring(metric.labels.device_name) | extend MetricLabelsDeviceType = tostring(metric.labels.device_type) | extend MetricType = tostring(metric.type) | extend ResourceType = tostring(resource.type) | extend ResourceLabelsZone = tostring(resource.labels.zone) | extend ResourceLabelsProjectId = tostring(resource.labels.project_id) | extend ResourceLabelsInstanceId = tostring(resource.labels.instance_id) | extend MetricKind = tostring(metricKind) | extend ValueType = tostring(valueType) | extend FirstPoint = array_index(points, 0) | extend PointsIntervalStartTime = todatetime(FirstPoint['interval']['startTime']) | extend PointsIntervalEndTime = todatetime(FirstPoint['interval']['endTime']) | extend PointsValueInt64Value = tolong(FirstPoint['value']['int64Value'])| project-away metric, resource, points",
                "outputStream": "Custom-GCP_MONITORINGV2_CL"
            }
        ]
    }
}