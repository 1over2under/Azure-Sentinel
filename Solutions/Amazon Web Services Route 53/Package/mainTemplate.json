{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Microsoft",
    "comments": "Solution template for Amazon Web Services Route 53"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "_solutionName": "Amazon Web Services Route 53",
    "_solutionVersion": "3.0.0",
    "solutionId": "azuresentinel.azure-sentinel-solution-amazonwebservicesroute53",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "AWSRoute53ResolverLogsCCPDefinition",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "AWSRoute53ResolverLogsCCPDefinitionConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Amazon Web Services S3 DNS Route53",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "AWSRoute53ResolverLogsCCPDefinition",
                  "title": "Amazon Web Services S3 DNS Route53",
                  "logo": "amazon_web_services_Logo.svg",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "This connector enables ingestion of AWS Route 53 DNS logs into Microsoft Sentinel for enhanced visibility and threat detection. It supports DNS Resolver query logs ingested directly from AWS S3 buckets, while Public DNS query logs and Route 53 audit logs can be ingested using Microsoft Sentinel's AWS CloudWatch and CloudTrail connectors. Comprehensive instructions are provided to guide you through the setup of each log type. Leverage this connector to monitor DNS activity, detect potential threats, and improve your security posture in cloud environments.",
                  "graphQueriesTableName": "AWSRoute53ResolverLogs_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total events received",
                      "legend": "Amazon Web Services S3 Resolver query logs",
                      "baseQuery": "{{graphQueriesTableName}}"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample of DNS Resolver query logs",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors",
                      "value": null
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": true,
                          "write": true,
                          "delete": true,
                          "action": false
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": false,
                          "write": false,
                          "delete": false,
                          "action": true
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "",
                      "description": "This connector enables the ingestion of AWS Route 53 DNS logs into Microsoft Sentinel, providing enhanced visibility into DNS activity and strengthening threat detection capabilities. It supports direct ingestion of DNS Resolver query logs from AWS S3 buckets, while Public DNS query logs and Route 53 audit logs can be ingested via Microsoft Sentinelâ€™s AWS CloudWatch and CloudTrail connectors. Detailed setup instructions are provided for each log type. Use this connector to monitor DNS traffic, identify potential threats, and enhance your cloud security posture.\n\nYou can ingest the following type of logs from AWS Route 53 to Microsoft Sentinel:\n1. Route 53 Resolver query logs\n2. Route 53 Public Hosted zones query logs (via Microsoft Sentinel CloudWatch connector)\n3. Route 53 audit logs (via Microsoft Sentinel CloudTrail connector)"
                    },
                    {
                      "instructions": [
                        {
                          "parameters": {
                            "instructionSteps": [
                              {
                                "title": "Ingesting Route53 Resolver query logs in Microsoft Sentinel",
                                "description": "### List of Resources Required:\n\n* Open ID Connect (OIDC) web identity provider\n* IAM Role\n* Amazon S3 Bucket\n* Amazon SQS\n* Route 53 Resolver query logging configuration\n* VPC to associate with Route53 Resolver query log config\n\n### 1. Configuration Steps:\n\n1. Download the CloudFormation templates provided below:\n   - [OIDCWebIdProvider.json](https://github.com/Azure/Azure-Sentinel/blob/c1344c7c13a718f771f444a54e51a3962a6dbbbd/DataConnectors/AWS-S3/CloudFormation/OIDCWebIdProvider.json): Template to configure the OIDC Web Identity Provider.\n   - [AWSRoute53ResolverLogs_CloudFormation.json](https://github.com/Azure/Azure-Sentinel/blob/c1344c7c13a718f771f444a54e51a3962a6dbbbd/DataConnectors/AWS-S3/CloudFormation/DNSRoute53/AWSRoute53ResolverLogs_CloudFormation.json): Template to deploy Route53 resources and configurations.\n2. Go to the [AWS CloudFormation Stacks](https://console.aws.amazon.com/cloudformation/home) page. Make sure to select the right AWS region where you want all resources to be created.\n3. Create a new Stack for each template:\n   - First, create Stack using the `OIDCWebIdProvider.json` template:\n     1. Click on \"Create Stack\".\n     2. Choose the \"With new resources (standard)\" option.\n     3. Click on \"Choose an existing template\", \"Upload a template file\" and select the `OIDCWebIdProvider.json` file.\n     4. Click \"Next\" and follow the prompts to create the Stack.\n   - Next, create another Stack using the `AWSRoute53ResolverLogs_CloudFormation.json` template:\n     1. Click on \"Create Stack\".\n     2. Choose the \"With new resources (standard)\" option.\n     3. Click on \"Choose an existing template\", \"Upload a template file\" and select the `AWSRoute53ResolverLogs_CloudFormation.json` file.\n     4. Click \"Next\" and follow the prompts to create the Stack.\n     5. After the Stack is successfully deployed, note down the 'Value' for the following 'Key's from the Stack 'Outputs' tab:\n        - `SentinelRoleArn`\n        - `SentinelSQSQueueURL`\n4. In the Azure portal, navigate to Microsoft Sentinel > Data Connectors, and search for the `Amazon Web Services S3 DNS Route53` data connector.\n5. Click on \"Add new collector\" and fill in the required information:\n   - `Role ARN`: Enter the Role ARN obtained from the CloudFormation stack.\n   - `Queue URL`: Enter the SQS Queue URL obtained from the CloudFormation stack.\n6. Click \"Connect\" to start ingesting logs to your Sentinel Workspace.",
                                "instructions": [
                                  {
                                    "type": "Markdown",
                                    "parameters": {
                                      "content": "### 2. Connect new collectors \n To enable Amazon Web Services S3 DNS Route53 for Microsoft Sentinel, click the Add new collector button, fill the required information in the context pane and click on Connect."
                                    }
                                  },
                                  {
                                    "type": "DataConnectorsGrid",
                                    "parameters": {
                                      "mapping": [
                                        {
                                          "columnValue": "properties.roleArn",
                                          "columnName": "Role ARN"
                                        },
                                        {
                                          "columnValue": "properties.sqsUrls[0]",
                                          "columnName": "Queue URL"
                                        }
                                      ],
                                      "menuItems": [
                                        "DeleteConnector"
                                      ]
                                    }
                                  },
                                  {
                                    "type": "ContextPane",
                                    "parameters": {
                                      "contextPaneType": "DataConnectorsContextPane",
                                      "title": "Add new controller",
                                      "subtitle": "AWS Security Hub connector",
                                      "label": "Add new collector",
                                      "instructionSteps": [
                                        {
                                          "title": "Account details",
                                          "instructions": [
                                            {
                                              "type": "Textbox",
                                              "parameters": {
                                                "label": "Role ARN",
                                                "type": "text",
                                                "name": "roleArn",
                                                "validations": {
                                                  "required": true
                                                }
                                              }
                                            },
                                            {
                                              "type": "Textbox",
                                              "parameters": {
                                                "label": "Queue URL",
                                                "type": "text",
                                                "name": "queueUrl",
                                                "validations": {
                                                  "required": true
                                                }
                                              }
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  }
                                ]
                              },
                              {
                                "title": "Ingesting Route 53 Public Hosted zones query logs (via Microsoft Sentinel CloudWatch connector)",
                                "description": "Public Hosted zone query logs are exported to CloudWatch service in AWS. We can use 'Amazon Web Services S3' connector to ingest CloudWatch logs from AWS to Microsoft Sentinel.",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "instructionSteps": [
                                        {
                                          "title": "Step 1: Configure logging for Public DNS queries",
                                          "description": "1. Sign in to the AWS Management Console and open the Route 53 console at [AWS Route 53](https://console.aws.amazon.com/route53/).\n2. Navigate to Route 53 > Hosted zones.\n3. Choose the Public hosted zone that you want to configure query logging for.\n4. In the Hosted zone details pane, click \"Configure query logging\".\n5. Choose an existing log group or create a new log group.\n6. Choose Create."
                                        },
                                        {
                                          "title": "Step 2: Configure Amazon Web Services S3 data connector for AWS CloudWatch",
                                          "description": "AWS CloudWatch logs can be exported to an S3 bucket using lambda function. To ingest Public DNS queries from `AWS CloudWatch` to `S3` bucket and then to Microsoft Sentinel, follow the instructions provided in the [Amazon Web Services S3 connector](https://learn.microsoft.com/en-us/azure/sentinel/connect-aws?tabs=s3)."
                                        }
                                      ]
                                    },
                                    "type": "InstructionStepsGroup"
                                  }
                                ]
                              },
                              {
                                "title": "Ingesting Route 53 audit logs (via Microsoft Sentinel CloudTrail connector)",
                                "description": "Route 53 audit logs i.e. the logs related to actions taken by user, role or AWS service in Route 53 can be exported to an S3 bucket via AWS CloudTrail service. We can use 'Amazon Web Services S3' connector to ingest CloudTrail logs from AWS to Microsoft Sentinel.",
                                "instructions": [
                                  {
                                    "parameters": {
                                      "instructionSteps": [
                                        {
                                          "title": "Step 1: Configure logging for AWS Route 53 Audit logs",
                                          "description": "1. Sign in to the AWS Management Console and open the CloudTrail console at [AWS CloudTrail](https://console.aws.amazon.com/cloudtrail)\n2. If you do not have an existing trail, click on 'Create trail'\n3. Enter a name for your trail in the Trail name field.\n4. Select Create new S3 bucket (you may also choose to use an existing S3 bucket).\n5. Leave the other settings as default, and click Next.\n6. Select Event type, make sure Management events is selected.\n7. Select API activity, 'Read' and 'Write'\n8. Click Next.\n9. Review the settings and click 'Create trail'."
                                        },
                                        {
                                          "title": "Step 2: Configure Amazon Web Services S3 data connector for AWS CloudTrail",
                                          "description": "To ingest audit and management logs from  `AWS Cloudtrail` to Microsoft Sentinel, follow the instructions provided in the [Amazon Web Services S3 connector](https://learn.microsoft.com/en-us/azure/sentinel/connect-aws?tabs=s3)"
                                        }
                                      ]
                                    },
                                    "type": "InstructionStepsGroup"
                                  }
                                ]
                              }
                            ]
                          },
                          "type": "InstructionStepsGroup"
                        }
                      ]
                    }
                  ],
                  "isConnectivityCriteriasMatchSome": false
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "AWSRoute53ResolverLogs_DCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-AWSRoute53ResolverLogs": {
                    "columns": [
                      {
                        "name": "version",
                        "type": "string"
                      },
                      {
                        "name": "account_id",
                        "type": "string"
                      },
                      {
                        "name": "region",
                        "type": "string"
                      },
                      {
                        "name": "vpc_id",
                        "type": "string"
                      },
                      {
                        "name": "query_timestamp",
                        "type": "datetime"
                      },
                      {
                        "name": "query_name",
                        "type": "string"
                      },
                      {
                        "name": "query_type",
                        "type": "string"
                      },
                      {
                        "name": "query_class",
                        "type": "string"
                      },
                      {
                        "name": "rcode",
                        "type": "string"
                      },
                      {
                        "name": "answers",
                        "type": "dynamic"
                      },
                      {
                        "name": "srcaddr",
                        "type": "string"
                      },
                      {
                        "name": "srcport",
                        "type": "string"
                      },
                      {
                        "name": "transport",
                        "type": "string"
                      },
                      {
                        "name": "srcids",
                        "type": "dynamic"
                      },
                      {
                        "name": "firewall_rule_action",
                        "type": "string"
                      },
                      {
                        "name": "firewall_rule_group_id",
                        "type": "string"
                      },
                      {
                        "name": "firewall_domain_list_id",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-AWSRoute53ResolverLogs"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | project Version = tostring(version), AccountId = tostring(account_id), Region = tostring(region), VpcId = tostring(vpc_id), TimeGenerated = todatetime(query_timestamp), QueryName = tostring(query_name), QueryType = tostring(query_type), QueryClass = tostring(query_class), Rcode = tostring(rcode), Answers = todynamic(answers), SrcAddr = tostring(srcaddr), SrcPort = tostring(srcport), Transport = tostring(transport), SrcIds = todynamic(srcids), FirewallRuleAction = tostring(firewall_rule_action), FirewallRuleGroupId = tostring(firewall_rule_group_id), FirewallDomainListId = tostring(firewall_domain_list_id), LogType = \"ResolverQueryLogs\"",
                    "outputStream": "Custom-AWSRoute53ResolverLogs_CL"
                  }
                ]
              }
            },
            {
              "name": "AWSRoute53ResolverLogs_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "AWSRoute53ResolverLogs_CL",
                  "columns": [
                    {
                      "name": "Version",
                      "type": "string"
                    },
                    {
                      "name": "AccountId",
                      "type": "string"
                    },
                    {
                      "name": "LogType",
                      "type": "string"
                    },
                    {
                      "name": "Region",
                      "type": "string"
                    },
                    {
                      "name": "VpcId",
                      "type": "string"
                    },
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "QueryName",
                      "type": "string"
                    },
                    {
                      "name": "QueryType",
                      "type": "string"
                    },
                    {
                      "name": "QueryClass",
                      "type": "string"
                    },
                    {
                      "name": "Rcode",
                      "type": "string"
                    },
                    {
                      "name": "Answers",
                      "type": "dynamic"
                    },
                    {
                      "name": "SrcAddr",
                      "type": "string"
                    },
                    {
                      "name": "SrcPort",
                      "type": "string"
                    },
                    {
                      "name": "Transport",
                      "type": "string"
                    },
                    {
                      "name": "SrcIds",
                      "type": "dynamic"
                    },
                    {
                      "name": "FirewallRuleAction",
                      "type": "string"
                    },
                    {
                      "name": "FirewallRuleGroupId",
                      "type": "string"
                    },
                    {
                      "name": "FirewallDomainListId",
                      "type": "string"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "AWSRoute53ResolverLogsCCPDefinition",
          "title": "Amazon Web Services S3 DNS Route53",
          "logo": "amazon_web_services_Logo.svg",
          "publisher": "Microsoft",
          "descriptionMarkdown": "This connector enables ingestion of AWS Route 53 DNS logs into Microsoft Sentinel for enhanced visibility and threat detection. It supports DNS Resolver query logs ingested directly from AWS S3 buckets, while Public DNS query logs and Route 53 audit logs can be ingested using Microsoft Sentinel's AWS CloudWatch and CloudTrail connectors. Comprehensive instructions are provided to guide you through the setup of each log type. Leverage this connector to monitor DNS activity, detect potential threats, and improve your security posture in cloud environments.",
          "graphQueriesTableName": "AWSRoute53ResolverLogs_CL",
          "graphQueries": [
            {
              "metricName": "Total events received",
              "legend": "Amazon Web Services S3 Resolver query logs",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample of DNS Resolver query logs",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | where TimeGenerated > ago(12h) | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors",
              "value": null
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true,
                  "action": false
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": false,
                  "write": false,
                  "delete": false,
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "",
              "description": "This connector enables the ingestion of AWS Route 53 DNS logs into Microsoft Sentinel, providing enhanced visibility into DNS activity and strengthening threat detection capabilities. It supports direct ingestion of DNS Resolver query logs from AWS S3 buckets, while Public DNS query logs and Route 53 audit logs can be ingested via Microsoft Sentinelâ€™s AWS CloudWatch and CloudTrail connectors. Detailed setup instructions are provided for each log type. Use this connector to monitor DNS traffic, identify potential threats, and enhance your cloud security posture.\n\nYou can ingest the following type of logs from AWS Route 53 to Microsoft Sentinel:\n1. Route 53 Resolver query logs\n2. Route 53 Public Hosted zones query logs (via Microsoft Sentinel CloudWatch connector)\n3. Route 53 audit logs (via Microsoft Sentinel CloudTrail connector)"
            },
            {
              "instructions": [
                {
                  "parameters": {
                    "instructionSteps": [
                      {
                        "title": "Ingesting Route53 Resolver query logs in Microsoft Sentinel",
                        "description": "### List of Resources Required:\n\n* Open ID Connect (OIDC) web identity provider\n* IAM Role\n* Amazon S3 Bucket\n* Amazon SQS\n* Route 53 Resolver query logging configuration\n* VPC to associate with Route53 Resolver query log config\n\n### 1. Configuration Steps:\n\n1. Download the CloudFormation templates provided below:\n   - [OIDCWebIdProvider.json](https://github.com/Azure/Azure-Sentinel/blob/c1344c7c13a718f771f444a54e51a3962a6dbbbd/DataConnectors/AWS-S3/CloudFormation/OIDCWebIdProvider.json): Template to configure the OIDC Web Identity Provider.\n   - [AWSRoute53ResolverLogs_CloudFormation.json](https://github.com/Azure/Azure-Sentinel/blob/c1344c7c13a718f771f444a54e51a3962a6dbbbd/DataConnectors/AWS-S3/CloudFormation/DNSRoute53/AWSRoute53ResolverLogs_CloudFormation.json): Template to deploy Route53 resources and configurations.\n2. Go to the [AWS CloudFormation Stacks](https://console.aws.amazon.com/cloudformation/home) page. Make sure to select the right AWS region where you want all resources to be created.\n3. Create a new Stack for each template:\n   - First, create Stack using the `OIDCWebIdProvider.json` template:\n     1. Click on \"Create Stack\".\n     2. Choose the \"With new resources (standard)\" option.\n     3. Click on \"Choose an existing template\", \"Upload a template file\" and select the `OIDCWebIdProvider.json` file.\n     4. Click \"Next\" and follow the prompts to create the Stack.\n   - Next, create another Stack using the `AWSRoute53ResolverLogs_CloudFormation.json` template:\n     1. Click on \"Create Stack\".\n     2. Choose the \"With new resources (standard)\" option.\n     3. Click on \"Choose an existing template\", \"Upload a template file\" and select the `AWSRoute53ResolverLogs_CloudFormation.json` file.\n     4. Click \"Next\" and follow the prompts to create the Stack.\n     5. After the Stack is successfully deployed, note down the 'Value' for the following 'Key's from the Stack 'Outputs' tab:\n        - `SentinelRoleArn`\n        - `SentinelSQSQueueURL`\n4. In the Azure portal, navigate to Microsoft Sentinel > Data Connectors, and search for the `Amazon Web Services S3 DNS Route53` data connector.\n5. Click on \"Add new collector\" and fill in the required information:\n   - `Role ARN`: Enter the Role ARN obtained from the CloudFormation stack.\n   - `Queue URL`: Enter the SQS Queue URL obtained from the CloudFormation stack.\n6. Click \"Connect\" to start ingesting logs to your Sentinel Workspace.",
                        "instructions": [
                          {
                            "type": "Markdown",
                            "parameters": {
                              "content": "### 2. Connect new collectors \n To enable Amazon Web Services S3 DNS Route53 for Microsoft Sentinel, click the Add new collector button, fill the required information in the context pane and click on Connect."
                            }
                          },
                          {
                            "type": "DataConnectorsGrid",
                            "parameters": {
                              "mapping": [
                                {
                                  "columnValue": "properties.roleArn",
                                  "columnName": "Role ARN"
                                },
                                {
                                  "columnValue": "properties.sqsUrls[0]",
                                  "columnName": "Queue URL"
                                }
                              ],
                              "menuItems": [
                                "DeleteConnector"
                              ]
                            }
                          },
                          {
                            "type": "ContextPane",
                            "parameters": {
                              "contextPaneType": "DataConnectorsContextPane",
                              "title": "Add new controller",
                              "subtitle": "AWS Security Hub connector",
                              "label": "Add new collector",
                              "instructionSteps": [
                                {
                                  "title": "Account details",
                                  "instructions": [
                                    {
                                      "type": "Textbox",
                                      "parameters": {
                                        "label": "Role ARN",
                                        "type": "text",
                                        "name": "roleArn",
                                        "validations": {
                                          "required": true
                                        }
                                      }
                                    },
                                    {
                                      "type": "Textbox",
                                      "parameters": {
                                        "label": "Queue URL",
                                        "type": "text",
                                        "name": "queueUrl",
                                        "validations": {
                                          "required": true
                                        }
                                      }
                                    }
                                  ]
                                }
                              ]
                            }
                          }
                        ]
                      },
                      {
                        "title": "Ingesting Route 53 Public Hosted zones query logs (via Microsoft Sentinel CloudWatch connector)",
                        "description": "Public Hosted zone query logs are exported to CloudWatch service in AWS. We can use 'Amazon Web Services S3' connector to ingest CloudWatch logs from AWS to Microsoft Sentinel.",
                        "instructions": [
                          {
                            "parameters": {
                              "instructionSteps": [
                                {
                                  "title": "Step 1: Configure logging for Public DNS queries",
                                  "description": "1. Sign in to the AWS Management Console and open the Route 53 console at [AWS Route 53](https://console.aws.amazon.com/route53/).\n2. Navigate to Route 53 > Hosted zones.\n3. Choose the Public hosted zone that you want to configure query logging for.\n4. In the Hosted zone details pane, click \"Configure query logging\".\n5. Choose an existing log group or create a new log group.\n6. Choose Create."
                                },
                                {
                                  "title": "Step 2: Configure Amazon Web Services S3 data connector for AWS CloudWatch",
                                  "description": "AWS CloudWatch logs can be exported to an S3 bucket using lambda function. To ingest Public DNS queries from `AWS CloudWatch` to `S3` bucket and then to Microsoft Sentinel, follow the instructions provided in the [Amazon Web Services S3 connector](https://learn.microsoft.com/en-us/azure/sentinel/connect-aws?tabs=s3)."
                                }
                              ]
                            },
                            "type": "InstructionStepsGroup"
                          }
                        ]
                      },
                      {
                        "title": "Ingesting Route 53 audit logs (via Microsoft Sentinel CloudTrail connector)",
                        "description": "Route 53 audit logs i.e. the logs related to actions taken by user, role or AWS service in Route 53 can be exported to an S3 bucket via AWS CloudTrail service. We can use 'Amazon Web Services S3' connector to ingest CloudTrail logs from AWS to Microsoft Sentinel.",
                        "instructions": [
                          {
                            "parameters": {
                              "instructionSteps": [
                                {
                                  "title": "Step 1: Configure logging for AWS Route 53 Audit logs",
                                  "description": "1. Sign in to the AWS Management Console and open the CloudTrail console at [AWS CloudTrail](https://console.aws.amazon.com/cloudtrail)\n2. If you do not have an existing trail, click on 'Create trail'\n3. Enter a name for your trail in the Trail name field.\n4. Select Create new S3 bucket (you may also choose to use an existing S3 bucket).\n5. Leave the other settings as default, and click Next.\n6. Select Event type, make sure Management events is selected.\n7. Select API activity, 'Read' and 'Write'\n8. Click Next.\n9. Review the settings and click 'Create trail'."
                                },
                                {
                                  "title": "Step 2: Configure Amazon Web Services S3 data connector for AWS CloudTrail",
                                  "description": "To ingest audit and management logs from  `AWS Cloudtrail` to Microsoft Sentinel, follow the instructions provided in the [Amazon Web Services S3 connector](https://learn.microsoft.com/en-us/azure/sentinel/connect-aws?tabs=s3)"
                                }
                              ]
                            },
                            "type": "InstructionStepsGroup"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ]
            }
          ],
          "isConnectivityCriteriasMatchSome": false
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Amazon Web Services S3 DNS Route53",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "string"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "string"
            },
            "roleArn": {
              "defaultValue": "Enter roleArn value",
              "type": "string",
              "minLength": 3
            },
            "queueUrl": {
              "defaultValue": "Enter queueUrl value",
              "type": "string",
              "minLength": 3
            },
            "connectorDefinitionName": {
              "defaultValue": "Amazon Web Services S3 DNS Route53",
              "type": "string",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "string"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "Microsoft"
                },
                "support": {
                  "name": "Microsoft Corporation",
                  "email": "support@microsoft.com",
                  "tier": "Microsoft",
                  "link": "https://support.microsoft.com"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'AWS S3 DNS Route53 Resolver Logs Polling Config', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "AmazonWebServicesS3",
              "properties": {
                "connectorDefinitionName": "AWSRoute53ResolverLogsCCPDefinition",
                "dataTypes": {
                  "logs": {
                    "state": "enabled"
                  }
                },
                "dcrConfig": {
                  "streamName": "Custom-AWSRoute53ResolverLogs",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "destinationTable": "AWSRoute53ResolverLogs_CL",
                "dataFormat": {
                  "Format": "Json",
                  "IsCompressed": true,
                  "compressType": "Gzip"
                },
                "roleArn": "[[parameters('roleArn')]",
                "sqsUrls": [
                  "[[parameters('queueUrl')]"
                ]
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "Amazon Web Services Route 53",
        "publisherDisplayName": "Microsoft Sentinel, Microsoft Corporation",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>â€¢ Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/Amazon%20Web%20Services%20Route%2053/ReleaseNotes.md\">Release Notes</a></p>\n<p>â€¢ There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>Amazon Web Services Route 53 Solution for Microsoft Sentinel provides data connector to ingest AWS Route 53 DNS logs into Microsoft Sentinel.</p>\n<p><strong>Data Connectors:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/Aws.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "Amazon Web Services Route 53",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "Microsoft"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2025-03-21",
        "providers": [
          "Microsoft"
        ],
        "categories": {
          "domains": [
            "Security - Cloud Security"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
