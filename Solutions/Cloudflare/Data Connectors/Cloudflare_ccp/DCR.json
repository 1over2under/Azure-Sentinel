{
    "name": "GitHubAuditLogsDCR",
    "apiVersion": "2022-06-01",
    "type": "Microsoft.Insights/dataCollectionRules",
    "location": "[parameters('workspace-location')]",
    "kind": "[variables('blanks')]",
    "properties": {
        "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
        "streamDeclarations": {
            "Custom-GitHubAuditLogsV2CL": {
                "columns": [
                    {
                        "name": "TimeGenerated",
                        "type": "datetime"
                    },
                    {
                        "name": "org",
                        "type": "string"
                    },
                    {
                        "name": "action",
                        "type": "string"
                    },
                    {
                        "name": "repo",
                        "type": "string"
                    },
                    {
                        "name": "actor",
                        "type": "string"
                    },
                    {
                        "name": "actor_location",
                        "type": "dynamic"
                    },
                    {
                        "name": "user",
                        "type": "string"
                    },
                    {
                        "name": "permission",
                        "type": "string"
                    },
                    {
                        "name": "visibility",
                        "type": "string"
                    },
                    {
                        "name": "previous_visibility",
                        "type": "string"
                    },
                    {
                        "name": "old_permission",
                        "type": "string"
                    },
                    {
                        "name": "team",
                        "type": "string"
                    },
                    {
                        "name": "blocked_user",
                        "type": "string"
                    },
                    {
                        "name": "operation_type",
                        "type": "string"
                    },
                    {
                        "name": "public_repo",
                        "type": "boolean"
                    },
                    {
                        "name": "org_id",
                        "type": "real"
                    },
                    {
                        "name": "created_at",
                        "type": "real"
                    },
                    {
                        "name": "invitee_email",
                        "type": "string"
                    },
                    {
                        "name": "actor_ip",
                        "type": "string"
                    },
                    {
                        "name": "@timestamp",
                        "type": "real"
                    },
                    {
                        "name": "actor_id",
                        "type": "real"
                    },
                    {
                        "name": "actor_is_bot",
                        "type": "boolean"
                    },
                    {
                        "name": "business_id",
                        "type": "real"
                    },
                    {
                        "name": "repo_id",
                        "type": "real"
                    },
                    {
                        "name": "user_agent",
                        "type": "string"
                    },
                    {
                        "name": "user_id",
                        "type": "real"
                    },
                    {
                        "name": "email",
                        "type": "string"
                    },
                    {
                        "name": "repository_security_configuration_failure_reason",
                        "type": "dynamic"
                    },
                    {
                        "name": "repository_security_configuration_state",
                        "type": "dynamic"
                    },
                    {
                        "name": "security_configuration_name",
                        "type": "string"
                    },
                    {
                        "name": "oauth_application",
                        "type": "string"
                    },
                    {
                        "name": "oauth_application_url",
                        "type": "string"
                    },
                    {
                        "name": "oauth_application_state",
                        "type": "string"
                    },
                    {
                        "name": "reason",
                        "type": "string"
                    },
                    {
                        "name": "membership_type",
                        "type": "string"
                    },
                    {
                        "name": "user_can_invite_collaborators",
                        "type": "boolean"
                    },
                    {
                        "name": "can_create_repositories",
                        "type": "boolean"
                    },
                    {
                        "name": "security_configuration_id",
                        "type": "real"
                    },
                    {
                        "name": "invitation_id",
                        "type": "real"
                    },
                    {
                        "name": "topic",
                        "type": "string"
                    },
                    {
                        "name": "_document_id",
                        "type": "string"
                    },
                    {
                        "name": "business",
                        "type": "string"
                    },
                    {
                        "name": "request_category",
                        "type": "string"
                    },
                    {
                        "name": "oauth_application_id",
                        "type": "real"
                    },
                    {
                        "name": "old_repo_permission",
                        "type": "string"
                    },
                    {
                        "name": "new_repo_permission",
                        "type": "string"
                    },
                    {
                        "name": "repositories_removed_names",
                        "type": "string"
                    }
                ]
            }
        },
        "destinations": {
            "logAnalytics": [
                {
                    "workspaceResourceId": "[variables('workspaceResourceId')]",
                    "name": "clv2ws1"
                }
            ]
        },
        "dataFlows": [
            {
                "streams": [
                    "Custom-GitHubAuditLogsV2CL"
                ],
                "destinations": [
                    "clv2ws1"
                ],
                "transformKql": "source | extend actor_locationDynamic = parse_json(actor_location) | extend CountryCode = tostring(actor_locationDynamic['country_code']) | extend City = tostring(actor_locationDynamic['city']) | project-rename Timestamp = ['@timestamp'], CreatedAt = created_at, Org = org, Action = action, Repo = repo, Actor = actor, User = user, Permission = permission, Visibility = visibility, PreviousVisibility = previous_visibility, OldPermission = old_permission, Team = team, BlockedUser = blocked_user, OperationType = operation_type, PublicRepo = public_repo, OrgId = org_id, InviteeEmail = invitee_email, ActorIp = actor_ip, ActorId = actor_id, ActorIsBot = actor_is_bot, BusinessId = business_id, RepoId = repo_id, UserAgent = user_agent, UserId = user_id, Email = email, RepositorySecurityConfigurationFailureReason = repository_security_configuration_failure_reason, RepositorySecurityConfigurationState = repository_security_configuration_state, SecurityConfigurationName = security_configuration_name, OauthApplication = oauth_application, OauthApplicationUrl = oauth_application_url, OauthApplicationState = oauth_application_state, Reason = reason, MembershipType = membership_type, UserCanInviteCollaborators = user_can_invite_collaborators, CanCreateRepositories = can_create_repositories, SecurityConfigurationId = security_configuration_id, InvitationId = invitation_id, Topic = topic, DocumentId = _document_id, Business = business, RequestCategory = request_category, OauthApplicationId = oauth_application_id, OldRepoPermission = old_repo_permission, NewRepoPermission = new_repo_permission, RepositoriesRemovedNames = repositories_removed_names",
                "outputStream": "Custom-GitHubAuditLogsV2_CL"
            }
        ]
    }
}