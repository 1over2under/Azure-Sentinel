{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "app-integrations@illumio.com",
    "comments": "Solution template for IllumioSaaS"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "_solutionName": "IllumioSaaS",
    "_solutionVersion": "3.4.0",
    "solutionId": "illumioinc1629822633689.illumio_sentinel",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "IllumioSaasCCFDefinition",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "IllumioSaasCCFDefinitionConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "uiConfigId2": "IllumioSaaSDataConnector",
    "_uiConfigId2": "[variables('uiConfigId2')]",
    "dataConnectorContentId2": "IllumioSaaSDataConnector",
    "_dataConnectorContentId2": "[variables('dataConnectorContentId2')]",
    "dataConnectorId2": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
    "_dataConnectorId2": "[variables('dataConnectorId2')]",
    "dataConnectorTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentId2'))))]",
    "dataConnectorVersion2": "1.2.0",
    "_dataConnectorcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentId2'),'-', variables('dataConnectorVersion2'))))]",
    "analyticRuleObject1": {
      "analyticRuleVersion1": "1.0.7",
      "_analyticRulecontentId1": "e9e4e466-3970-4165-bc8d-7721c6ef34a6",
      "analyticRuleId1": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'e9e4e466-3970-4165-bc8d-7721c6ef34a6')]",
      "analyticRuleTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('e9e4e466-3970-4165-bc8d-7721c6ef34a6')))]",
      "_analyticRulecontentProductId1": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','e9e4e466-3970-4165-bc8d-7721c6ef34a6','-', '1.0.7')))]"
    },
    "analyticRuleObject2": {
      "analyticRuleVersion2": "1.0.7",
      "_analyticRulecontentId2": "599fdc92-eb6d-4b54-8d79-2a3f740a846a",
      "analyticRuleId2": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '599fdc92-eb6d-4b54-8d79-2a3f740a846a')]",
      "analyticRuleTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('599fdc92-eb6d-4b54-8d79-2a3f740a846a')))]",
      "_analyticRulecontentProductId2": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','599fdc92-eb6d-4b54-8d79-2a3f740a846a','-', '1.0.7')))]"
    },
    "analyticRuleObject3": {
      "analyticRuleVersion3": "1.0.7",
      "_analyticRulecontentId3": "ec07fcd3-724f-426d-9f53-041801ca5f6c",
      "analyticRuleId3": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'ec07fcd3-724f-426d-9f53-041801ca5f6c')]",
      "analyticRuleTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('ec07fcd3-724f-426d-9f53-041801ca5f6c')))]",
      "_analyticRulecontentProductId3": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','ec07fcd3-724f-426d-9f53-041801ca5f6c','-', '1.0.7')))]"
    },
    "analyticRuleObject4": {
      "analyticRuleVersion4": "1.0.6",
      "_analyticRulecontentId4": "b3c4b8f4-c12c-471e-9999-023c05852276",
      "analyticRuleId4": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'b3c4b8f4-c12c-471e-9999-023c05852276')]",
      "analyticRuleTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('b3c4b8f4-c12c-471e-9999-023c05852276')))]",
      "_analyticRulecontentProductId4": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','b3c4b8f4-c12c-471e-9999-023c05852276','-', '1.0.6')))]"
    },
    "analyticRuleObject5": {
      "analyticRuleVersion5": "1.0.6",
      "_analyticRulecontentId5": "c18bd8c2-50f0-4aa2-8122-d449243627d7",
      "analyticRuleId5": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', 'c18bd8c2-50f0-4aa2-8122-d449243627d7')]",
      "analyticRuleTemplateSpecName5": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('c18bd8c2-50f0-4aa2-8122-d449243627d7')))]",
      "_analyticRulecontentProductId5": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','c18bd8c2-50f0-4aa2-8122-d449243627d7','-', '1.0.6')))]"
    },
    "analyticRuleObject6": {
      "analyticRuleVersion6": "1.0.6",
      "_analyticRulecontentId6": "7379f752-18a2-43ca-8b74-70747dd792f8",
      "analyticRuleId6": "[resourceId('Microsoft.SecurityInsights/AlertRuleTemplates', '7379f752-18a2-43ca-8b74-70747dd792f8')]",
      "analyticRuleTemplateSpecName6": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-ar-',uniquestring('7379f752-18a2-43ca-8b74-70747dd792f8')))]",
      "_analyticRulecontentProductId6": "[concat(take(variables('_solutionId'),50),'-','ar','-', uniqueString(concat(variables('_solutionId'),'-','AnalyticsRule','-','7379f752-18a2-43ca-8b74-70747dd792f8','-', '1.0.6')))]"
    },
    "IllumioSaaS_FunctionAppConnector": "IllumioSaaS_FunctionAppConnector",
    "_IllumioSaaS_FunctionAppConnector": "[variables('IllumioSaaS_FunctionAppConnector')]",
    "TemplateEmptyArray": "[json('[]')]",
    "playbookVersion1": "1.0",
    "playbookContentId1": "IllumioSaaS_FunctionAppConnector",
    "_playbookContentId1": "[variables('playbookContentId1')]",
    "playbookTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-fa-',uniquestring(variables('_playbookContentId1'))))]",
    "_playbookcontentProductId1": "[concat(take(variables('_solutionId'),50),'-','fa','-', uniqueString(concat(variables('_solutionId'),'-','AzureFunction','-',variables('_playbookContentId1'),'-', variables('playbookVersion1'))))]",
    "Illumio-Get-Ven-Details": "Illumio-Get-Ven-Details",
    "_Illumio-Get-Ven-Details": "[variables('Illumio-Get-Ven-Details')]",
    "playbookVersion2": "1.0",
    "playbookContentId2": "Illumio-Get-Ven-Details",
    "_playbookContentId2": "[variables('playbookContentId2')]",
    "playbookId2": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId2'))]",
    "playbookTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId2'))))]",
    "_playbookcontentProductId2": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId2'),'-', variables('playbookVersion2'))))]",
    "Illumio-Port-Blocking-Switch": "Illumio-Port-Blocking-Switch",
    "_Illumio-Port-Blocking-Switch": "[variables('Illumio-Port-Blocking-Switch')]",
    "playbookVersion3": "1.0",
    "playbookContentId3": "Illumio-Port-Blocking-Switch",
    "_playbookContentId3": "[variables('playbookContentId3')]",
    "playbookId3": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId3'))]",
    "playbookTemplateSpecName3": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId3'))))]",
    "_playbookcontentProductId3": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId3'),'-', variables('playbookVersion3'))))]",
    "Illumio-Quarantine-Workload": "Illumio-Quarantine-Workload",
    "_Illumio-Quarantine-Workload": "[variables('Illumio-Quarantine-Workload')]",
    "playbookVersion4": "1.0",
    "playbookContentId4": "Illumio-Quarantine-Workload",
    "_playbookContentId4": "[variables('playbookContentId4')]",
    "playbookId4": "[resourceId('Microsoft.Logic/workflows', variables('playbookContentId4'))]",
    "playbookTemplateSpecName4": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pl-',uniquestring(variables('_playbookContentId4'))))]",
    "_playbookcontentProductId4": "[concat(take(variables('_solutionId'),50),'-','pl','-', uniqueString(concat(variables('_solutionId'),'-','Playbook','-',variables('_playbookContentId4'),'-', variables('playbookVersion4'))))]",
    "parserObject1": {
      "_parserName1": "[concat(parameters('workspace'),'/','IllumioSyslogAuditEvents')]",
      "_parserId1": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogAuditEvents')]",
      "parserTemplateSpecName1": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('IllumioSyslogAuditEvents-Parser')))]",
      "parserVersion1": "1.0.0",
      "parserContentId1": "IllumioSyslogAuditEvents-Parser"
    },
    "parserObject2": {
      "_parserName2": "[concat(parameters('workspace'),'/','IllumioSyslogNetworkTrafficEvents')]",
      "_parserId2": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogNetworkTrafficEvents')]",
      "parserTemplateSpecName2": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat(parameters('workspace'),'-pr-',uniquestring('IllumioSyslogNetworkTrafficEvents-Parser')))]",
      "parserVersion2": "1.0.0",
      "parserContentId2": "IllumioSyslogNetworkTrafficEvents-Parser"
    },
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "Illumio Saas",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "IllumioSaasCCFDefinition",
                  "title": "Illumio Saas",
                  "publisher": "Microsoft",
                  "descriptionMarkdown": "The Illumio Saas Cloud data connector provides the capability to ingest logs into Microsoft Sentinel using the Illumio Saas Log Integration through AWS S3 Bucket. Refer to [Illumio Saas Log Integration](https://product-docs-repo.illumio.com/Tech-Docs/CloudSecure/out/en/administer-cloudsecure/connector.html#UUID-c14edaab-9726-1f23-9c4c-bc2937be39ee_section-idm234556433515698) for more information.",
                  "graphQueriesTableName": "IllumioFlowV2_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total Illumio Flow events received",
                      "legend": "Illumio Flow Logs",
                      "baseQuery": "{{graphQueriesTableName}}"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Get Sample of Illumio Flow logs",
                      "query": "{{graphQueriesTableName}}\n | take 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors"
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "read": true,
                          "write": true,
                          "delete": true,
                          "action": false
                        }
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "Connect Illumio Saas to Microsoft Sentinel\n\n",
                      "instructions": [
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": ">**NOTE:** This connector fetches the Illumio Saas logs from AWS S3 bucket"
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "To gather data from Illumio, you need to configure the following resources"
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### 1. AWS Role ARN \n To gather data from Illumio, you'll need AWS Role ARN."
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "#### 2. AWS SQS Queue URL \n To gather data from Illumio, you'll need AWS SQS Queue URL.\n\n"
                          }
                        },
                        {
                          "type": "Markdown",
                          "parameters": {
                            "content": "For detailed steps to retrieve the AWS Role ARN, SQS Queue URL, and configure Illumio log forwarding to the Amazon S3 bucket, refer to the [Connector Setup Guide](https://github.com/v-pmalreddy/IllumioSaas/blob/main/README.md)."
                          }
                        },
                        {
                          "type": "DataConnectorsGrid",
                          "parameters": {
                            "mapping": [
                              {
                                "columnValue": "properties.roleArn",
                                "columnName": "AWS Role ARN"
                              },
                              {
                                "columnValue": "properties.sqsUrls[0]",
                                "columnName": "AWS SQS Queue URL"
                              }
                            ],
                            "menuItems": [
                              "DeleteConnector"
                            ]
                          }
                        },
                        {
                          "type": "ContextPane",
                          "parameters": {
                            "isPrimary": true,
                            "label": "Add Account",
                            "title": "Add Account",
                            "subtitle": "Add Account",
                            "contextPaneType": "DataConnectorsContextPane",
                            "instructionSteps": [
                              {
                                "instructions": [
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Role ARN",
                                      "placeholder": "Enter Role ARN",
                                      "type": "text",
                                      "name": "roleArn",
                                      "required": true
                                    }
                                  },
                                  {
                                    "type": "Textbox",
                                    "parameters": {
                                      "label": "Queue URL",
                                      "placeholder": "Enter SQL Queue URL",
                                      "type": "text",
                                      "name": "queueUrl",
                                      "required": true
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "IllumioSaasDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-IllumioSaasFlow": {
                    "columns": [
                      {
                        "name": "Src",
                        "type": "string"
                      },
                      {
                        "name": "SrcCloud",
                        "type": "string"
                      },
                      {
                        "name": "SrcType",
                        "type": "string"
                      },
                      {
                        "name": "SrcName",
                        "type": "string"
                      },
                      {
                        "name": "SrcLabels",
                        "type": "string"
                      },
                      {
                        "name": "Dst",
                        "type": "string"
                      },
                      {
                        "name": "DstCloud",
                        "type": "string"
                      },
                      {
                        "name": "DstType",
                        "type": "string"
                      },
                      {
                        "name": "DstName",
                        "type": "string"
                      },
                      {
                        "name": "DstLabels",
                        "type": "string"
                      },
                      {
                        "name": "Status",
                        "type": "string"
                      },
                      {
                        "name": "StartTime",
                        "type": "datetime"
                      },
                      {
                        "name": "EndTime",
                        "type": "datetime"
                      },
                      {
                        "name": "SrcIP",
                        "type": "string"
                      },
                      {
                        "name": "DstIP",
                        "type": "string"
                      },
                      {
                        "name": "DstPort",
                        "type": "string"
                      },
                      {
                        "name": "Protocol",
                        "type": "string"
                      },
                      {
                        "name": "Bytes",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-IllumioSaasFlow"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = StartTime | project TimeGenerated, Bytes, Dst, DstCloud, DstIP, DstLabels, DstName, DstPort, DstType, EndTime, Protocol, Src, SrcCloud, SrcIP, SrcLabels, SrcName, SrcType, Status",
                    "outputStream": "Custom-IllumioFlowV2_CL"
                  }
                ]
              }
            },
            {
              "name": "IllumioFlowV2_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "IllumioFlowV2_CL",
                  "columns": [
                    {
                      "name": "Bytes",
                      "type": "string"
                    },
                    {
                      "name": "Dst",
                      "type": "string"
                    },
                    {
                      "name": "DstCloud",
                      "type": "string"
                    },
                    {
                      "name": "DstIP",
                      "type": "string"
                    },
                    {
                      "name": "DstLabels",
                      "type": "string"
                    },
                    {
                      "name": "DstName",
                      "type": "string"
                    },
                    {
                      "name": "DstPort",
                      "type": "string"
                    },
                    {
                      "name": "DstType",
                      "type": "string"
                    },
                    {
                      "name": "EndTime",
                      "type": "datetime"
                    },
                    {
                      "name": "Protocol",
                      "type": "string"
                    },
                    {
                      "name": "Src",
                      "type": "string"
                    },
                    {
                      "name": "SrcCloud",
                      "type": "string"
                    },
                    {
                      "name": "SrcIP",
                      "type": "string"
                    },
                    {
                      "name": "SrcLabels",
                      "type": "string"
                    },
                    {
                      "name": "SrcName",
                      "type": "string"
                    },
                    {
                      "name": "SrcType",
                      "type": "string"
                    },
                    {
                      "name": "Status",
                      "type": "string"
                    },
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "IllumioSaasCCFDefinition",
          "title": "Illumio Saas",
          "publisher": "Microsoft",
          "descriptionMarkdown": "The Illumio Saas Cloud data connector provides the capability to ingest logs into Microsoft Sentinel using the Illumio Saas Log Integration through AWS S3 Bucket. Refer to [Illumio Saas Log Integration](https://product-docs-repo.illumio.com/Tech-Docs/CloudSecure/out/en/administer-cloudsecure/connector.html#UUID-c14edaab-9726-1f23-9c4c-bc2937be39ee_section-idm234556433515698) for more information.",
          "graphQueriesTableName": "IllumioFlowV2_CL",
          "graphQueries": [
            {
              "metricName": "Total Illumio Flow events received",
              "legend": "Illumio Flow Logs",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "Get Sample of Illumio Flow logs",
              "query": "{{graphQueriesTableName}}\n | take 10"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true,
                  "action": false
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "Connect Illumio Saas to Microsoft Sentinel\n\n",
              "instructions": [
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": ">**NOTE:** This connector fetches the Illumio Saas logs from AWS S3 bucket"
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "To gather data from Illumio, you need to configure the following resources"
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### 1. AWS Role ARN \n To gather data from Illumio, you'll need AWS Role ARN."
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "#### 2. AWS SQS Queue URL \n To gather data from Illumio, you'll need AWS SQS Queue URL.\n\n"
                  }
                },
                {
                  "type": "Markdown",
                  "parameters": {
                    "content": "For detailed steps to retrieve the AWS Role ARN, SQS Queue URL, and configure Illumio log forwarding to the Amazon S3 bucket, refer to the [Connector Setup Guide](https://github.com/v-pmalreddy/IllumioSaas/blob/main/README.md)."
                  }
                },
                {
                  "type": "DataConnectorsGrid",
                  "parameters": {
                    "mapping": [
                      {
                        "columnValue": "properties.roleArn",
                        "columnName": "AWS Role ARN"
                      },
                      {
                        "columnValue": "properties.sqsUrls[0]",
                        "columnName": "AWS SQS Queue URL"
                      }
                    ],
                    "menuItems": [
                      "DeleteConnector"
                    ]
                  }
                },
                {
                  "type": "ContextPane",
                  "parameters": {
                    "isPrimary": true,
                    "label": "Add Account",
                    "title": "Add Account",
                    "subtitle": "Add Account",
                    "contextPaneType": "DataConnectorsContextPane",
                    "instructionSteps": [
                      {
                        "instructions": [
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Role ARN",
                              "placeholder": "Enter Role ARN",
                              "type": "text",
                              "name": "roleArn",
                              "required": true
                            }
                          },
                          {
                            "type": "Textbox",
                            "parameters": {
                              "label": "Queue URL",
                              "placeholder": "Enter SQL Queue URL",
                              "type": "text",
                              "name": "queueUrl",
                              "required": true
                            }
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "app-integrations@illumio.com"
        },
        "support": {
          "name": "Illumio",
          "email": "app-integrations@illumio.com",
          "tier": "Partner",
          "link": "https://www.illumio.com/support/support"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "Illumio Saas",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "Illumio Saas",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "roleArn": {
              "defaultValue": "roleArn",
              "type": "securestring",
              "minLength": 1
            },
            "queueUrl": {
              "defaultValue": "queueUrl",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'IllumioSaasFlowLogsCCF', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "AmazonWebServicesS3",
              "properties": {
                "connectorDefinitionName": "IllumioSaasCCFDefinition",
                "dataTypes": {
                  "logs": {
                    "state": "enabled"
                  }
                },
                "dcrConfig": {
                  "streamName": "Custom-IllumioSaasFlow",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "destinationTable": "IllumioFlowV2_CL",
                "dataFormat": {
                  "Format": "csv",
                  "IsCompressed": false,
                  "compressType": "None",
                  "HasCsvHeader": true,
                  "CsvDelimiter": ","
                },
                "roleArn": "[[parameters('roleArn')]",
                "sqsUrls": [
                  "[[parameters('queueUrl')]"
                ]
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('dataConnectorTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IllumioSaaS data connector with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorVersion2')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
              "apiVersion": "2021-03-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "GenericUI",
              "properties": {
                "connectorUiConfig": {
                  "id": "[variables('_uiConfigId2')]",
                  "title": "Illumio SaaS (using Azure Functions)",
                  "publisher": "Illumio",
                  "descriptionMarkdown": "[Illumio](https://www.illumio.com/) connector provides the capability to ingest events into Microsoft Sentinel. The connector provides ability to ingest auditable and flow events from AWS S3 bucket.",
                  "graphQueries": [
                    {
                      "metricName": "Total auditable events received",
                      "legend": "Illumio auditable events",
                      "baseQuery": "Illumio_Auditable_Events_CL"
                    },
                    {
                      "metricName": "Total flow summaries received",
                      "legend": "Illumio flow summaries",
                      "baseQuery": "Illumio_Flow_Events_CL"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "Sample of auditable events",
                      "query": "Illumio_Auditable_Events_CL \n | sort by TimeGenerated desc \n | limit 10"
                    },
                    {
                      "description": "Sample of flow summaries",
                      "query": "Illumio_Flow_Events_CL \n | sort by TimeGenerated desc \n | limit 10"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "Illumio_Auditable_Events_CL",
                      "lastDataReceivedQuery": "Illumio_Auditable_Events_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    },
                    {
                      "name": "Illumio_Flow_Events_CL",
                      "lastDataReceivedQuery": "Illumio_Flow_Events_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriterias": [
                    {
                      "type": "IsConnectedQuery",
                      "value": [
                        "Illumio_Flow_Events_CL            | summarize LastLogReceived = max(TimeGenerated)            | project IsConnected = LastLogReceived > ago(30d)",
                        "Illumio_Auditable_Events_CL            | summarize LastLogReceived = max(TimeGenerated)            | project IsConnected = LastLogReceived > ago(30d)"
                      ]
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "read and write permissions on the workspace are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "Microsoft.Web/sites permissions",
                        "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
                      },
                      {
                        "name": "SQS and AWS S3 account credentials/permissions",
                        "description": "**AWS_SECRET**, **AWS_REGION_NAME**, **AWS_KEY**, **QUEUE_URL** is required.  [See the documentation to learn more about data pulling](<Replace with an entry to documentation>). If you are using s3 bucket provided by Illumio, contact Illumio support. At your request they will provide you with the AWS S3 bucket name, AWS SQS url and AWS credentials to access them."
                      },
                      {
                        "name": "Illumio API key and secret",
                        "description": "**ILLUMIO_API_KEY**, **ILLUMIO_API_SECRET** is required for a workbook to make connection to SaaS PCE and fetch api responses."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "description": ">**NOTE:** This connector uses Azure Functions to connect to the AWS SQS / S3 to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details.\n\n>**(Optional Step)** Securely store API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
                    },
                    {
                      "description": "1. Ensure AWS SQS is configured for the s3 bucket from which flow and auditable event logs are going to be pulled. In case, Illumio provides bucket, please contact Illumio support for sqs url, s3 bucket name and aws credentials. \n 2. Register AAD application - For DCR (Data collection rule) to authentiate to ingest data into log analytics, you must use Entra application. 1. [Follow the instructions here](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/tutorial-logs-ingestion-portal#create-azure-ad-application) (steps 1-5) to get **AAD Tenant Id**, **AAD Client Id** and **AAD Client Secret**. \n 2. Ensure you have created a log analytics workspace. \nPlease keep note of the name and region where it has been deployed.",
                      "title": "Prerequisites"
                    },
                    {
                      "description": "Choose one of the approaches from below options. Either use the below ARM template to deploy azure resources or deploy function app manually.",
                      "title": "Deployment"
                    },
                    {
                      "description": "Use this method for automated deployment of Azure resources using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-IllumioSaaS-FunctionApp) \t\t\t\n2. Provide the required details such as Microsoft Sentinel Workspace, AWS credentials, Azure AD Application details and ingestion configurations \n> **NOTE:** It is recommended to create a new Resource Group for deployment of function app and associated resources.\n3. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n4. Click **Purchase** to deploy.",
                      "title": "1. Azure Resource Manager (ARM) Template"
                    },
                    {
                      "description": "Use this method for automated deployment of additional function apps using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-IllumioSaaS-QueueTriggerFunctionApp) \t\t\t\n",
                      "title": "2. Deploy additional function apps to handle scale"
                    },
                    {
                      "description": "Deployment via Visual Studio Code.",
                      "title": "3. Manual Deployment of Azure Functions"
                    },
                    {
                      "description": "**1. Deploy a Function App**\n\n1. Download the [Azure Function App](https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/IllumioSaaS/Data%20Connectors/IllumioEventsConn.zip) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeployment.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
                    },
                    {
                      "description": "**2. Configure the Function App**\n\n1. Follow documentation <insert link> to set up all required environment variables and click **Save**. Ensure you restart the function app once settings are saved."
                    }
                  ],
                  "metadata": {
                    "version": "1.2.0"
                  }
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2023-04-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
                "contentId": "[variables('_dataConnectorContentId2')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_dataConnectorContentId2')]",
        "contentKind": "DataConnector",
        "displayName": "Illumio SaaS (using Azure Functions)",
        "contentProductId": "[variables('_dataConnectorcontentProductId2')]",
        "id": "[variables('_dataConnectorcontentProductId2')]",
        "version": "[variables('dataConnectorVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', last(split(variables('_dataConnectorId2'),'/'))))]",
      "dependsOn": [
        "[variables('_dataConnectorId2')]"
      ],
      "location": "[parameters('workspace-location')]",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentId2'))]",
        "contentId": "[variables('_dataConnectorContentId2')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorVersion2')]",
        "source": {
          "kind": "Solution",
          "name": "IllumioSaaS",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "app-integrations@illumio.com"
        },
        "support": {
          "name": "Illumio",
          "email": "app-integrations@illumio.com",
          "tier": "Partner",
          "link": "https://www.illumio.com/support/support"
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentId2'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Illumio SaaS (using Azure Functions)",
          "publisher": "Illumio",
          "descriptionMarkdown": "[Illumio](https://www.illumio.com/) connector provides the capability to ingest events into Microsoft Sentinel. The connector provides ability to ingest auditable and flow events from AWS S3 bucket.",
          "graphQueries": [
            {
              "metricName": "Total auditable events received",
              "legend": "Illumio auditable events",
              "baseQuery": "Illumio_Auditable_Events_CL"
            },
            {
              "metricName": "Total flow summaries received",
              "legend": "Illumio flow summaries",
              "baseQuery": "Illumio_Flow_Events_CL"
            }
          ],
          "dataTypes": [
            {
              "name": "Illumio_Auditable_Events_CL",
              "lastDataReceivedQuery": "Illumio_Auditable_Events_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            },
            {
              "name": "Illumio_Flow_Events_CL",
              "lastDataReceivedQuery": "Illumio_Flow_Events_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "Illumio_Flow_Events_CL            | summarize LastLogReceived = max(TimeGenerated)            | project IsConnected = LastLogReceived > ago(30d)",
                "Illumio_Auditable_Events_CL            | summarize LastLogReceived = max(TimeGenerated)            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "sampleQueries": [
            {
              "description": "Sample of auditable events",
              "query": "Illumio_Auditable_Events_CL \n | sort by TimeGenerated desc \n | limit 10"
            },
            {
              "description": "Sample of flow summaries",
              "query": "Illumio_Flow_Events_CL \n | sort by TimeGenerated desc \n | limit 10"
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "SQS and AWS S3 account credentials/permissions",
                "description": "**AWS_SECRET**, **AWS_REGION_NAME**, **AWS_KEY**, **QUEUE_URL** is required.  [See the documentation to learn more about data pulling](<Replace with an entry to documentation>). If you are using s3 bucket provided by Illumio, contact Illumio support. At your request they will provide you with the AWS S3 bucket name, AWS SQS url and AWS credentials to access them."
              },
              {
                "name": "Illumio API key and secret",
                "description": "**ILLUMIO_API_KEY**, **ILLUMIO_API_SECRET** is required for a workbook to make connection to SaaS PCE and fetch api responses."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the AWS SQS / S3 to pull logs into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details.\n\n>**(Optional Step)** Securely store API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": "1. Ensure AWS SQS is configured for the s3 bucket from which flow and auditable event logs are going to be pulled. In case, Illumio provides bucket, please contact Illumio support for sqs url, s3 bucket name and aws credentials. \n 2. Register AAD application - For DCR (Data collection rule) to authentiate to ingest data into log analytics, you must use Entra application. 1. [Follow the instructions here](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/tutorial-logs-ingestion-portal#create-azure-ad-application) (steps 1-5) to get **AAD Tenant Id**, **AAD Client Id** and **AAD Client Secret**. \n 2. Ensure you have created a log analytics workspace. \nPlease keep note of the name and region where it has been deployed.",
              "title": "Prerequisites"
            },
            {
              "description": "Choose one of the approaches from below options. Either use the below ARM template to deploy azure resources or deploy function app manually.",
              "title": "Deployment"
            },
            {
              "description": "Use this method for automated deployment of Azure resources using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-IllumioSaaS-FunctionApp) \t\t\t\n2. Provide the required details such as Microsoft Sentinel Workspace, AWS credentials, Azure AD Application details and ingestion configurations \n> **NOTE:** It is recommended to create a new Resource Group for deployment of function app and associated resources.\n3. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n4. Click **Purchase** to deploy.",
              "title": "1. Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use this method for automated deployment of additional function apps using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-IllumioSaaS-QueueTriggerFunctionApp) \t\t\t\n",
              "title": "2. Deploy additional function apps to handle scale"
            },
            {
              "description": "Deployment via Visual Studio Code.",
              "title": "3. Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n1. Download the [Azure Function App](https://github.com/Azure/Azure-Sentinel/raw/master/Solutions/IllumioSaaS/Data%20Connectors/IllumioEventsConn.zip) file. Extract archive to your local development computer.\n2. Follow the [function app manual deployment instructions](https://github.com/Azure/Azure-Sentinel/blob/master/DataConnectors/AzureFunctionsManualDeployment.md#function-app-manual-deployment-instructions) to deploy the Azure Functions app using VSCode.\n3. After successful deployment of the function app, follow next steps for configuring it."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. Follow documentation <insert link> to set up all required environment variables and click **Save**. Ensure you restart the function app once settings are saved."
            }
          ],
          "id": "[variables('_uiConfigId2')]"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject1').analyticRuleTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Firewall_Tampering_Detection_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject1').analyticRuleVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When Firewall Is Tampered With",
                "displayName": "Illumio Firewall Tampering Analytic Rule",
                "enabled": false,
                "query": "Illumio_Auditable_Events_CL\n | union IllumioSyslogAuditEvents \n | where event_type has 'tampering'\n | extend ipaddress = action.src_ip,\n           hostname = created_by.agent.hostname,\n           ven_href = created_by.ven.href\n | project-away resource_changes, action, version\n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "hostname"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipaddress"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio Firewall Tamper Incident for {{hostname}}\n",
                  "alertDescriptionFormat": "Illumio Firewall Tamper Incident for {{hostname}} generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject1').analyticRuleId1,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 1",
                "parentId": "[variables('analyticRuleObject1').analyticRuleId1]",
                "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject1').analyticRuleVersion1]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio Firewall Tampering Analytic Rule",
        "contentProductId": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "id": "[variables('analyticRuleObject1')._analyticRulecontentProductId1]",
        "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject2').analyticRuleTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Enforcement_Change_Detection_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject2').analyticRuleVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When Ven Changes Enforcement State from Full/Selective To Idle/Visibility state",
                "displayName": "Illumio Enforcement Change Analytic Rule",
                "enabled": false,
                "query": "let enf_state = dynamic([\"full\", \"selective\"]);\nlet visibility_state = dynamic([\"visibility_only\", \"idle\"]);\nIllumio_Auditable_Events_CL\n| union IllumioSyslogAuditEvents\n| extend temp_resource_changes = parse_json(resource_changes)[0]\n| where event_type == 'workloads.update' \n| extend old_mode = temp_resource_changes.changes.enforcement_mode.before,\n        new_mode = temp_resource_changes.changes.enforcement_mode.after,\n        workload_href = temp_resource_changes.resource.workload.href,\n        workload_name = temp_resource_changes.resource.workload.hostname,\n        ipaddress = action.src_ip\n| where new_mode in (visibility_state) and old_mode in (enf_state)\n| project-away temp_*\n| project old_mode, new_mode, workload_href, workload_name, TimeGenerated, created_by, ipaddress\n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "workload_name"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Name",
                        "columnName": "created_by"
                      }
                    ],
                    "entityType": "Account"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipaddress"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio Enforcement Change Incident for {{workload_name}}\n",
                  "alertDescriptionFormat": "Illumio Enforcement Change Incident for {{workload_name}} generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject2').analyticRuleId2,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 2",
                "parentId": "[variables('analyticRuleObject2').analyticRuleId2]",
                "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject2').analyticRuleVersion2]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio Enforcement Change Analytic Rule",
        "contentProductId": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "id": "[variables('analyticRuleObject2')._analyticRulecontentProductId2]",
        "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject3').analyticRuleTemplateSpecName3]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Offline_Detection_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject3').analyticRuleVersion3]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When Ven Goes Into Offline state",
                "displayName": "Illumio VEN Offline Detection Rule",
                "enabled": false,
                "query": "Illumio_Auditable_Events_CL\n| union IllumioSyslogAuditEvents    \n| where event_type has 'agent_offline_check'\n| mv-expand resource_changes\n| extend hostname = resource_changes['resource']['workload']['hostname'],\n    workload_href = resource_changes['resource']['workload']['href'],\n    workload_labels = resource_changes['resource']['workload']['labels']\n| project-away resource_changes, version, notifications, action, severity, status // action field will have filtered ip addr, so no point of using IP entity\n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "hostname"
                      }
                    ],
                    "entityType": "Host"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio VEN Offline Incident for {{hostname}}\n",
                  "alertDescriptionFormat": "Illumio VEN Offline Incident for {{hostname}} generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject3').analyticRuleId3,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 3",
                "parentId": "[variables('analyticRuleObject3').analyticRuleId3]",
                "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject3').analyticRuleVersion3]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio VEN Offline Detection Rule",
        "contentProductId": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "id": "[variables('analyticRuleObject3')._analyticRulecontentProductId3]",
        "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject4').analyticRuleTemplateSpecName4]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Clone_Detection_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject4').analyticRuleVersion4]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When A Cloned Ven Is Detected",
                "displayName": "Illumio VEN Clone Detection Rule",
                "enabled": false,
                "query": "Illumio_Auditable_Events_CL\n| union IllumioSyslogAuditEvents  \n| where event_type has 'agent.clone_detected'\n| extend hostname = created_by.agent.hostname,\n        ven_href = created_by.ven.href\n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "hostname"
                      }
                    ],
                    "entityType": "Host"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio VEN Clone Detection Incident for {{hostname}}\n",
                  "alertDescriptionFormat": "Illumio VEN Clone Detection for {{hostname}} generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject4').analyticRuleId4,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 4",
                "parentId": "[variables('analyticRuleObject4').analyticRuleId4]",
                "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject4').analyticRuleVersion4]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio VEN Clone Detection Rule",
        "contentProductId": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "id": "[variables('analyticRuleObject4')._analyticRulecontentProductId4]",
        "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject5').analyticRuleTemplateSpecName5]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Deactivated_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject5').analyticRuleVersion5]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When Ven Goes Into Deactivated state",
                "displayName": "Illumio VEN Deactivated Detection Rule",
                "enabled": false,
                "query": "Illumio_Auditable_Events_CL\n| union IllumioSyslogAuditEvents  \n| where event_type has 'agent.deactivate'\n| mv-expand resource_changes\n| extend hostname = resource_changes['resource']['workload']['hostname'],\n    workload_href = resource_changes['resource']['workload']['href'],\n    workload_labels = resource_changes['resource']['workload']['labels']\n| extend ipaddress = action.src_ip,       \n      ven_href = created_by.ven.href\n| project-away resource_changes, action, version \n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "hostname"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipaddress"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio VEN Deactivated Incident\n",
                  "alertDescriptionFormat": "Illumio VEN Deactivated Incident generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject5').analyticRuleId5,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 5",
                "parentId": "[variables('analyticRuleObject5').analyticRuleId5]",
                "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject5').analyticRuleVersion5]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio VEN Deactivated Detection Rule",
        "contentProductId": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "id": "[variables('analyticRuleObject5')._analyticRulecontentProductId5]",
        "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('analyticRuleObject6').analyticRuleTemplateSpecName6]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio_VEN_Suspend_Query_AnalyticalRules Analytics Rule with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('analyticRuleObject6').analyticRuleVersion6]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.SecurityInsights/AlertRuleTemplates",
              "name": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "apiVersion": "2023-02-01-preview",
              "kind": "Scheduled",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "description": "Create Microsoft Sentinel Incident When Ven Goes Into Suspended state",
                "displayName": "Illumio VEN Suspend Detection Rule",
                "enabled": false,
                "query": "Illumio_Auditable_Events_CL\n| union IllumioSyslogAuditEvents  \n| where event_type has 'agent.suspend'\n| extend ipaddress = action.src_ip,\n      hostname = created_by.agent.hostname\n| project-away resource_changes, action, version        \n",
                "queryFrequency": "PT60M",
                "queryPeriod": "PT60M",
                "severity": "High",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "status": "Available",
                "requiredDataConnectors": [
                  {
                    "dataTypes": [
                      "Illumio_Auditable_Events_CL"
                    ],
                    "connectorId": "IllumioSaaSDataConnector"
                  },
                  {
                    "datatypes": [
                      "Syslog"
                    ],
                    "connectorId": "SyslogAma"
                  }
                ],
                "tactics": [
                  "DefenseEvasion"
                ],
                "techniques": [
                  "T1562"
                ],
                "entityMappings": [
                  {
                    "fieldMappings": [
                      {
                        "identifier": "HostName",
                        "columnName": "hostname"
                      }
                    ],
                    "entityType": "Host"
                  },
                  {
                    "fieldMappings": [
                      {
                        "identifier": "Address",
                        "columnName": "ipaddress"
                      }
                    ],
                    "entityType": "IP"
                  }
                ],
                "eventGroupingSettings": {
                  "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                  "alertDisplayNameFormat": "Illumio VEN Suspended Incident for {{hostname}}\n",
                  "alertDescriptionFormat": "Illumio VEN Suspended Incident for {{hostname}} generated at {{TimeGenerated}}\n"
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('AnalyticsRule-', last(split(variables('analyticRuleObject6').analyticRuleId6,'/'))))]",
              "properties": {
                "description": "IllumioSaaS Analytics Rule 6",
                "parentId": "[variables('analyticRuleObject6').analyticRuleId6]",
                "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
                "kind": "AnalyticsRule",
                "version": "[variables('analyticRuleObject6').analyticRuleVersion6]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
        "contentKind": "AnalyticsRule",
        "displayName": "Illumio VEN Suspend Detection Rule",
        "contentProductId": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "id": "[variables('analyticRuleObject6')._analyticRulecontentProductId6]",
        "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName1')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IllumioSaaS_FunctionAppConnector Playbook with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion1')]",
          "parameters": {
            "FunctionAppName": {
              "defaultValue": "illumiopbfuncapp",
              "type": "String",
              "metadata": {
                "description": "Function app Name"
              }
            },
            "StorageAccountName": {
              "type": "String",
              "metadata": {
                "description": "Storage name should be globally unique name"
              }
            },
            "PCE_FQDN": {
              "type": "String",
              "metadata": {
                "description": "FQDN of PCE"
              }
            },
            "PORT": {
              "type": "String",
              "metadata": {
                "description": "Port that PCE connects to, like 443"
              }
            },
            "ORG_ID": {
              "type": "String",
              "metadata": {
                "description": "Customer's org id"
              }
            },
            "API_KEY": {
              "type": "String",
              "metadata": {
                "description": "API key"
              }
            },
            "API_SECRET": {
              "type": "String",
              "metadata": {
                "description": "API secret"
              }
            }
          },
          "variables": {
            "hostingPlanName": "[[parameters('FunctionAppName')]",
            "storageAccountName": "[[parameters('StorageAccountName')]",
            "functionAppName": "[[parameters('FunctionAppName')]",
            "applicationInsightsName": "[[parameters('FunctionAppName')]",
            "pceFQDN": "[[parameters('PCE_FQDN')]",
            "port": "[[parameters('PORT')]",
            "orgId": "[[parameters('ORG_ID')]",
            "apiKey": "[[parameters('API_KEY')]",
            "apiSecret": "[[parameters('API_SECRET')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "playbookContentId1": "IllumioSaaS_FunctionAppConnector",
            "playbookId1": "[[resourceId('Microsoft.Logic/workflows', variables('playbookContentId1'))]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-03-01",
              "name": "[[variables('hostingPlanName')]",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {
                "name": "[[variables('hostingPlanName')]",
                "computeMode": "Dynamic"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-04-01",
              "name": "[[variables('storageAccountName')]",
              "location": "[[variables('workspace-location-inline')]",
              "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": "true",
                "allowBlobPublicAccess": "false",
                "allowSharedKeyAccess": "true",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow",
                  "ipRules": "[variables('TemplateEmptyArray')]"
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[[variables('applicationInsightsName')]",
              "location": "[[variables('workspace-location-inline')]",
              "tags": {
                "[[concat('hidden-link:', resourceId('Microsoft.Web/sites', variables('applicationInsightsName')))]": "Resource"
              },
              "properties": {
                "Application_Type": "web"
              },
              "kind": "web"
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[[variables('functionAppName')]",
              "location": "[[variables('workspace-location-inline')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "[[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
              ],
              "properties": {
                "serverFarmId": "[[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';EndpointSuffix=', environment().suffixes.storage, ';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-04-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "node"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~20"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[[reference(resourceId('microsoft.insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "https://raw.githubusercontent.com/illumio-shield/Azure-Sentinel/illumio-sentinel-playbook-v2/Solutions/IllumioSaaS/Playbooks/CustomConnector/IllumioSaaS_FunctionAppConnector/IllumioSaaS_FunctionAppForPlaybooks.zip"
                    },
                    {
                      "name": "PCE_FQDN",
                      "value": "[[variables('pceFQDN')]"
                    },
                    {
                      "name": "PORT",
                      "value": "[[variables('port')]"
                    },
                    {
                      "name": "ORG_ID",
                      "value": "[[variables('orgId')]"
                    },
                    {
                      "name": "API_KEY",
                      "value": "[[variables('apiKey')]"
                    },
                    {
                      "name": "API_SECRET",
                      "value": "[[variables('apiSecret')]"
                    }
                  ]
                },
                "cors": {
                  "allowedOrigins": [
                    "https://functions.azure.com",
                    "https://functions-staging.azure.com",
                    "https://functions-next.azure.com"
                  ],
                  "supportCredentials": false
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[[concat(variables('workspace-name'),'/Microsoft.SecurityInsights/',concat('AzureFunction-', last(split(variables('playbookId1'),'/'))))]",
              "properties": {
                "parentId": "[[variables('playbookId1')]",
                "contentId": "[variables('_playbookContentId1')]",
                "kind": "AzureFunction",
                "version": "[variables('playbookVersion1')]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId1')]",
        "contentKind": "AzureFunction",
        "displayName": "IllumioSaaS_FunctionAppConnector",
        "contentProductId": "[variables('_playbookcontentProductId1')]",
        "id": "[variables('_playbookcontentProductId1')]",
        "version": "[variables('playbookVersion1')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName2')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio-Ven-Details Playbook with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion2')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Illumio-Ven-Details",
              "type": "String",
              "metadata": {
                "description": "PlayBook Name"
              }
            },
            "DeployersUserName": {
              "defaultValue": "<username>@<domain>",
              "type": "string"
            },
            "FunctionAppName": {
              "defaultValue": "illumiopbfuncapp",
              "type": "String",
              "metadata": {
                "description": "Function app Name"
              }
            }
          },
          "variables": {
            "o365ConnectionName": "[[concat('o365-', parameters('PlaybookName'))]",
            "sentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('o365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('DeployersUserName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('sentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[parameters('DeployersUserName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "location": "[[variables('workspace-location-inline')]",
              "name": "[[parameters('PlaybookName')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "Microsoft_Sentinel_alert": {
                      "type": "ApiConnectionWebhook",
                      "inputs": {
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "body": {
                          "callback_url": "@listCallbackUrl()"
                        },
                        "path": "/subscribe"
                      }
                    }
                  },
                  "actions": {
                    "IllumioVenDetails-fetchVenDetails": {
                      "type": "Function",
                      "inputs": {
                        "body": "@triggerBody()",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/fetchVenDetails')]"
                        }
                      }
                    },
                    "Initialize_variable": {
                      "runAfter": {
                        "IllumioVenDetails-fetchVenDetails": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "varStyle",
                            "type": "object",
                            "value": {
                              "cellStyle": "style=\"font-family: Calibri; padding: 5px; border: 1px solid black;\"",
                              "headerStyle": "style=\"font-family: Helvetica; padding: 5px; border: 1px solid black;\"",
                              "numcellStyle": "style=\"font-family: Calibri; padding: 5px; border: 1px solid black;text-align: center;\"",
                              "rowStyleHighValues": "style=\"font-size:110%;background-color:#b32400; padding: 5px; border: 1px solid black;text-align: center;\"",
                              "rowStyleInfoValues": "style=\"background-color:#a6a6a6; padding: 5px; border: 1px solid black;text-align: center;\"",
                              "rowStyleLowValues": "style=\"background-color:#ffcc00; padding: 5px; border: 1px solid black;text-align: center;\"",
                              "rowStyleMedValues": "style=\"background-color:#ff6600; padding: 5px; border: 1px solid black;text-align: center;\"",
                              "tableStyle": "style=\"border-collapse: collapse;\""
                            }
                          }
                        ]
                      }
                    },
                    "Initialize_variable_1": {
                      "runAfter": {
                        "Initialize_variable": [
                          "Succeeded"
                        ]
                      },
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "varHTMLTable",
                            "type": "string",
                            "value": "<table @{variables('varStyle').tableStyle}>\n   <tr>\n     <th @{variables('varStyle').headerStyle}>Created Time</th>\n     <th @{variables('varStyle').headerStyle}>Title</th>\n     <th @{variables('varStyle').headerStyle}>Severity</th>\n     <th @{variables('varStyle').headerStyle}>Description</th>\n   </tr>"
                          }
                        ]
                      }
                    },
                    "Initialize_variable_2": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "varSeverityColour",
                            "type": "string",
                            "value": "@triggerBody()?['Severity']"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_3": [
                          "Succeeded"
                        ]
                      }
                    },
                    "Parse_JSON": {
                      "runAfter": {
                        "Initialize_variable_2": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('IllumioVenDetails-fetchVenDetails')",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "response": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "public_ip": {
                                    "type": [
                                      "string",
                                      "null"
                                    ]
                                  },
                                  "hostname": {
                                    "type": [
                                      "string",
                                      "null"
                                    ]
                                  },
                                  "labels": {
                                    "type": "array",
                                    "items": {
                                      "type": "object",
                                      "properties": {
                                        "href": {
                                          "type": "string"
                                        },
                                        "key": {
                                          "type": "string"
                                        },
                                        "value": {
                                          "type": "string"
                                        }
                                      },
                                      "required": [
                                        "href",
                                        "key",
                                        "value"
                                      ]
                                    }
                                  }
                                },
                                "required": [
                                  "public_ip",
                                  "hostname",
                                  "labels"
                                ]
                              }
                            }
                          }
                        }
                      }
                    },
                    "For_each": {
                      "type": "Foreach",
                      "foreach": "@body('Parse_JSON')?['response']",
                      "actions": {
                        "Append_to_string_variable": {
                          "type": "AppendToStringVariable",
                          "inputs": {
                            "name": "EntityTable",
                            "value": "<tr>\n     <td @{variables('varStyle').cellStyle}>@{item()?['public_ip']}</td>\n     <td @{variables('varStyle').cellStyle}>@{item()?['hostname']}</td>       \n     <td @{variables('varStyle').cellStyle}>@{item()?['labels']}</td>               \n</tr>"
                          }
                        }
                      },
                      "runAfter": {
                        "Parse_JSON": [
                          "Succeeded"
                        ]
                      }
                    },
                    "Append_to_string_variable_2": {
                      "type": "AppendToStringVariable",
                      "inputs": {
                        "name": "varHTMLTable",
                        "value": "</table>"
                      },
                      "runAfter": {
                        "Append_to_string_variable_1": [
                          "SUCCEEDED"
                        ]
                      }
                    },
                    "Condition": {
                      "type": "If",
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Parse_JSON')?['response'])",
                              0
                            ]
                          }
                        ]
                      },
                      "actions": {
                        "Send_an_email_(V2)": {
                          "type": "ApiConnection",
                          "inputs": {
                            "host": {
                              "connection": {
                                "name": "@parameters('$connections')['office365']['connectionId']"
                              }
                            },
                            "method": "post",
                            "body": {
                              "To": "user@domain.com",
                              "Subject": "Microsoft Sentinel: @{triggerBody()?['AlertDisplayName']}",
                              "Body": "<p class=\"editor-paragraph\">In the following, is more information, about the new Azure Sentinel alert:</p><br><p class=\"editor-paragraph\">@{variables('varHTMLTable')}</p><br><p class=\"editor-paragraph\">And VEN details pertaining to entities are</p><br><p class=\"editor-paragraph\">@{variables('EntityTable')}</p><p class=\"editor-paragraph\">Illumio</p>",
                              "Importance": "Normal"
                            },
                            "path": "/v2/Mail"
                          }
                        }
                      },
                      "runAfter": {
                        "Append_to_string_variable_3": [
                          "Succeeded"
                        ]
                      }
                    },
                    "Initialize_variable_3": {
                      "type": "InitializeVariable",
                      "inputs": {
                        "variables": [
                          {
                            "name": "EntityTable",
                            "type": "string",
                            "value": "<table @{variables('varStyle').tableStyle}>\n   <tr>\n     <th @{variables('varStyle').headerStyle}>IP Address</th>\n     <th @{variables('varStyle').headerStyle}>Hostname</th>\n     <th @{variables('varStyle').headerStyle}>Labels</th>\n   </tr>"
                          }
                        ]
                      },
                      "runAfter": {
                        "Initialize_variable_1": [
                          "Succeeded"
                        ]
                      }
                    },
                    "Append_to_string_variable_3": {
                      "type": "AppendToStringVariable",
                      "inputs": {
                        "name": "EntityTable",
                        "value": "</table>"
                      },
                      "runAfter": {
                        "Append_to_string_variable_2": [
                          "SUCCEEDED"
                        ]
                      }
                    },
                    "Append_to_string_variable_1": {
                      "type": "AppendToStringVariable",
                      "inputs": {
                        "name": "varHTMLTable",
                        "value": "   <tr>\n     <th @{variables('varStyle').cellStyle}>@{triggerBody()?['TimeGenerated']}</th>\n     <th @{variables('varStyle').cellStyle}>@{triggerBody()?['AlertDisplayName']}</th>\n     <th @{variables('varStyle').cellStyle}>@{triggerBody()?['Severity']}</th>\n     <th @{variables('varStyle').cellStyle}>@{triggerBody()?['Description']}</th>\n   </tr>"
                      },
                      "runAfter": {
                        "For_each": [
                          "Succeeded"
                        ]
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]",
                        "connectionName": "[[variables('sentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                        "connectionName": "[[variables('o365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId2'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId2')]",
                "contentId": "[variables('_playbookContentId2')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion2')]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "AzureFunction",
                      "contentId": "[variables('_IllumioSaaS_FunctionAppConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Illumio Get Ven Details Playbook",
            "description": "This playbook leverages Illumio workloads API to enrich IP, Hostname and Labels, found in Microsoft Sentinel alerts.  <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Get-Ven-Details/Images/illumio-get-ven-details-playbook.png\"/>.",
            "prerequisites": [
              "To use this playbook, ensure that you have valid API key and secret, org id and pce fqdn. Ensure that you deploy the template with the required context."
            ],
            "postDeployment": [
              "After deployment open the playbook in edit mode and configure/authorize all connections and press save. <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Get-Ven-Details/Images/illumio-get-ven-details-playbook.png\"/>"
            ],
            "lastUpdateTime": "2024-11-21T00:00:00Z",
            "entities": [
              "ip",
              "host"
            ],
            "tags": [
              "Enrichment"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Illumio Get Ven Details",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId2')]",
        "contentKind": "Playbook",
        "displayName": "Illumio-Ven-Details",
        "contentProductId": "[variables('_playbookcontentProductId2')]",
        "id": "[variables('_playbookcontentProductId2')]",
        "version": "[variables('playbookVersion2')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName3')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio-Port-Blocking-Switch Playbook with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion3')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Illumio-Port-Blocking-Switch",
              "type": "String",
              "metadata": {
                "description": "PlayBook Name"
              }
            },
            "FunctionAppName": {
              "defaultValue": "illumiopbfuncapp",
              "type": "String",
              "metadata": {
                "description": "Function app Name"
              }
            }
          },
          "variables": {
            "hostingPlanName": "[[parameters('FunctionAppName')]",
            "storageAccountName": "[[parameters('FunctionAppName')]",
            "functionAppName": "[[parameters('FunctionAppName')]",
            "applicationInsightsName": "[[parameters('FunctionAppName')]",
            "o365ConnectionName": "[[concat('o365-', parameters('PlaybookName'))]",
            "sentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('o365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('o365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('sentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('sentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "location": "[[variables('workspace-location-inline')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]"
              ],
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_HTTP_request_is_received": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "protocol": {
                              "type": "integer"
                            },
                            "port": {
                              "type": "integer"
                            }
                          }
                        }
                      }
                    }
                  },
                  "actions": {
                    "PortBlockingFunction-runTrafficQuery": {
                      "type": "Function",
                      "inputs": {
                        "body": "@triggerBody()",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/runTrafficQuery')]"
                        }
                      }
                    },
                    "PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults": {
                      "runAfter": {
                        "PortBlockingFunction-runTrafficQuery": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-runTrafficQuery')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/fetchVisibilityOnlyWorkloadsFromTrafficResults')]"
                        }
                      }
                    },
                    "PortBlockingFunction-createVirtualService": {
                      "runAfter": {
                        "PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/createVirtualService')]"
                        }
                      }
                    },
                    "PortBlockingFunction-bindWorkloadsToVirtualService": {
                      "runAfter": {
                        "PortBlockingFunction-createVirtualService": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-createVirtualService')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/bindWorkloadsToVirtualService')]"
                        }
                      }
                    },
                    "PortBlockingFunction-createAllowRuleForVirtualService": {
                      "runAfter": {
                        "PortBlockingFunction-bindWorkloadsToVirtualService": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-bindWorkloadsToVirtualService')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/createAllowRuleForVirtualService')]"
                        }
                      }
                    },
                    "PortBlockingFunction-changeWorkloadEnforcementState": {
                      "runAfter": {
                        "PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/changeWorkloadEnforcementState')]"
                        }
                      }
                    },
                    "PortBlockingFunction-createDenyRule": {
                      "runAfter": {
                        "PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults": [
                          "Succeeded"
                        ]
                      },
                      "type": "Function",
                      "inputs": {
                        "body": "@body('PortBlockingFunction-fetchVisibilityOnlyWorkloadsFromTrafficResults')",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/createDenyRule')]"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]",
                        "connectionName": "[[variables('sentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                        "connectionName": "[[variables('o365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId3'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId3')]",
                "contentId": "[variables('_playbookContentId3')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion3')]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "AzureFunction",
                      "contentId": "[variables('_IllumioSaaS_FunctionAppConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Illumio Containment Switch Playbook",
            "description": "This playbook leverages Illumio workloads API to contain and isolate a workload based on user inputs.  <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Port-Blocking-Switch/Images/illumio-port-blocking-switch-playbook.png\"/>.",
            "prerequisites": [
              "To use this playbook, ensure that you have valid API key and secret, org id and pce fqdn. Ensure that you deploy the template with the required context."
            ],
            "postDeployment": [
              "After deployment open the playbook in edit mode and configure/authorize all connections and press save. <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Port-Blocking-Switch/Images/illumio-port-blocking-switch-playbook.png\"/>"
            ],
            "lastUpdateTime": "2024-11-21T00:00:00Z",
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Illumio Containment Switch",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId3')]",
        "contentKind": "Playbook",
        "displayName": "Illumio-Port-Blocking-Switch",
        "contentProductId": "[variables('_playbookcontentProductId3')]",
        "id": "[variables('_playbookcontentProductId3')]",
        "version": "[variables('playbookVersion3')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('playbookTemplateSpecName4')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "Illumio-Quarantine-Workload Playbook with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('playbookVersion4')]",
          "parameters": {
            "PlaybookName": {
              "defaultValue": "Illumio-Quarantine-Workload",
              "type": "String",
              "metadata": {
                "description": "PlayBook Name"
              }
            },
            "FunctionAppName": {
              "defaultValue": "illumiopbfuncapp",
              "type": "String",
              "metadata": {
                "description": "Function app Name"
              }
            }
          },
          "variables": {
            "functionAppName": "[[parameters('FunctionAppName')]",
            "o365ConnectionName": "[[concat('o365-', parameters('PlaybookName'))]",
            "sentinelConnectionName": "[[concat('azuresentinel-', parameters('PlaybookName'))]",
            "connection-1": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]",
            "_connection-1": "[[variables('connection-1')]",
            "connection-2": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]",
            "_connection-2": "[[variables('connection-2')]",
            "workspace-location-inline": "[concat('[resourceGroup().locatio', 'n]')]",
            "workspace-name": "[parameters('workspace')]",
            "workspaceResourceId": "[[resourceId('microsoft.OperationalInsights/Workspaces', variables('workspace-name'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('o365ConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('o365ConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-1')]"
                }
              }
            },
            {
              "type": "Microsoft.Web/connections",
              "apiVersion": "2016-06-01",
              "name": "[[variables('sentinelConnectionName')]",
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "displayName": "[[variables('sentinelConnectionName')]",
                "api": {
                  "id": "[[variables('_connection-2')]"
                }
              }
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2017-07-01",
              "name": "[[parameters('PlaybookName')]",
              "dependsOn": [
                "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]"
              ],
              "location": "[[variables('workspace-location-inline')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "$connections": {
                      "type": "Object"
                    }
                  },
                  "triggers": {
                    "When_a_HTTP_request_is_received": {
                      "type": "Request",
                      "kind": "Http",
                      "inputs": {
                        "method": "POST",
                        "schema": {
                          "type": "object",
                          "properties": {
                            "workloads": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            },
                            "labels": {
                              "type": "array",
                              "items": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "actions": {
                    "QuarantineWorkloadFuncApp-quarantineWorkloadHTTPTrigger": {
                      "type": "Function",
                      "inputs": {
                        "body": "@triggerBody()",
                        "function": {
                          "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/sites/',parameters('Functionappname'), '/functions/quarantineWorkloadHTTPTrigger')]"
                        }
                      }
                    }
                  }
                },
                "parameters": {
                  "$connections": {
                    "value": {
                      "azuresentinel": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('sentinelConnectionName'))]",
                        "connectionName": "[[variables('sentinelConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/azuresentinel')]"
                      },
                      "office365": {
                        "connectionId": "[[resourceId('Microsoft.Web/connections', variables('o365ConnectionName'))]",
                        "connectionName": "[[variables('o365ConnectionName')]",
                        "id": "[[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', variables('workspace-location-inline'), '/managedApis/office365')]"
                      }
                    }
                  }
                }
              },
              "tags": {
                "hidden-SentinelWorkspaceId": "[[variables('workspaceResourceId')]"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Playbook-', last(split(variables('playbookId4'),'/'))))]",
              "properties": {
                "parentId": "[variables('playbookId4')]",
                "contentId": "[variables('_playbookContentId4')]",
                "kind": "Playbook",
                "version": "[variables('playbookVersion4')]",
                "source": {
                  "kind": "Solution",
                  "name": "IllumioSaaS",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "kind": "AzureFunction",
                      "contentId": "[variables('_IllumioSaaS_FunctionAppConnector')]",
                      "version": "[variables('playbookVersion1')]"
                    }
                  ]
                }
              }
            }
          ],
          "metadata": {
            "title": "Illumio Workload Quarantine Playbook",
            "description": "This playbook leverages Illumio workloads API to quarantine a workload based on user inputs.  <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Quarantine-Workload/Images/illumio-quarantine-workload.png\"/>.",
            "prerequisites": [
              "To use this playbook, ensure that you have valid API key and secret, org id and pce fqdn. Ensure that you deploy the template with the required context."
            ],
            "postDeployment": [
              "After deployment open the playbook in edit mode and configure/authorize all connections and press save. <img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Solutions/IllumioSaaS/Playbooks/Illumio-Quarantine-Workload/Images/illumio-quarantine-workload.png\"/>"
            ],
            "lastUpdateTime": "2024-12-10T00:00:00Z",
            "tags": [
              "Remediation"
            ],
            "releaseNotes": [
              {
                "version": "1.0",
                "title": "Illumio Quarantine Workload",
                "notes": [
                  "Initial version"
                ]
              }
            ]
          }
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('_playbookContentId4')]",
        "contentKind": "Playbook",
        "displayName": "Illumio-Quarantine-Workload",
        "contentProductId": "[variables('_playbookcontentProductId4')]",
        "id": "[variables('_playbookcontentProductId4')]",
        "version": "[variables('playbookVersion4')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserObject1').parserTemplateSpecName1]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IllumioSyslogAuditEvents Data Parser with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserObject1').parserVersion1]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('parserObject1')._parserName1]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for Illumio Syslog Audit Events",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "IllumioSyslogAuditEvents",
                "query": "Syslog\n| where SyslogMessage has 'illumio_pce/agent'\n| extend JsonPayload = extract(@\"\\{.*\\}\", 0, SyslogMessage)\n| where isnotempty(JsonPayload)\n| extend ParsedJson = parse_json(JsonPayload)\n| project \n    TimeGenerated = todatetime(ParsedJson.timestamp),\n    href = tostring(ParsedJson.href),\n    pce_fqdn = tostring(ParsedJson.pce_fqdn),\n    created_by = todynamic(ParsedJson.created_by),\n    event_type = tostring(ParsedJson.event_type),\n    status = tostring(ParsedJson.status),\n    severity = tostring(ParsedJson.severity),\n    action = todynamic(ParsedJson.action),\n    resource_changes = todynamic(ParsedJson.resource_changes),\n    notifications = todynamic(ParsedJson.notifications),\n    version = toint(ParsedJson.version),\n    Type = 'Illumio Syslog Audit Events'\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
              "dependsOn": [
                "[variables('parserObject1')._parserId1]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogAuditEvents')]",
                "contentId": "[variables('parserObject1').parserContentId1]",
                "kind": "Parser",
                "version": "[variables('parserObject1').parserVersion1]",
                "source": {
                  "name": "IllumioSaaS",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "contentKind": "Parser",
        "displayName": "Parser for Illumio Syslog Audit Events",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject1').parserContentId1,'-', '1.0.0')))]",
        "version": "[variables('parserObject1').parserVersion1]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('parserObject1')._parserName1]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for Illumio Syslog Audit Events",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "IllumioSyslogAuditEvents",
        "query": "Syslog\n| where SyslogMessage has 'illumio_pce/agent'\n| extend JsonPayload = extract(@\"\\{.*\\}\", 0, SyslogMessage)\n| where isnotempty(JsonPayload)\n| extend ParsedJson = parse_json(JsonPayload)\n| project \n    TimeGenerated = todatetime(ParsedJson.timestamp),\n    href = tostring(ParsedJson.href),\n    pce_fqdn = tostring(ParsedJson.pce_fqdn),\n    created_by = todynamic(ParsedJson.created_by),\n    event_type = tostring(ParsedJson.event_type),\n    status = tostring(ParsedJson.status),\n    severity = tostring(ParsedJson.severity),\n    action = todynamic(ParsedJson.action),\n    resource_changes = todynamic(ParsedJson.resource_changes),\n    notifications = todynamic(ParsedJson.notifications),\n    version = toint(ParsedJson.version),\n    Type = 'Illumio Syslog Audit Events'\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject1')._parserId1,'/'))))]",
      "dependsOn": [
        "[variables('parserObject1')._parserId1]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogAuditEvents')]",
        "contentId": "[variables('parserObject1').parserContentId1]",
        "kind": "Parser",
        "version": "[variables('parserObject1').parserVersion1]",
        "source": {
          "kind": "Solution",
          "name": "IllumioSaaS",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "app-integrations@illumio.com"
        },
        "support": {
          "name": "Illumio",
          "email": "app-integrations@illumio.com",
          "tier": "Partner",
          "link": "https://www.illumio.com/support/support"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[variables('parserObject2').parserTemplateSpecName2]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "description": "IllumioSyslogNetworkTrafficEvents Data Parser with template version 3.4.0",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('parserObject2').parserVersion2]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('parserObject2')._parserName2]",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "location": "[parameters('workspace-location')]",
              "properties": {
                "eTag": "*",
                "displayName": "Parser for Illumio Syslog Network Traffic Events",
                "category": "Microsoft Sentinel Parser",
                "functionAlias": "IllumioSyslogNetworkTrafficEvents",
                "query": "Syslog\n| where SyslogMessage has 'illumio_pce/collector'\n| extend JsonPayload = extract(@\"\\{.*\\}\", 0, SyslogMessage)\n| where isnotempty(JsonPayload)\n| extend ParsedJson = parse_json(JsonPayload)\n| project\n  TimeGenerated = todatetime(ParsedJson.timestamp),\n  tdms = toint(ParsedJson.tdms),\n  ddms = toint(ParsedJson.ddms),\n  pn = tostring(ParsedJson.pn),\n  un = tostring(ParsedJson.un),\n  src_ip = tostring(ParsedJson.src_ip),\n  dst_ip = tostring(ParsedJson.dst_ip),\n  class = tostring(ParsedJson.class),\n  proto = toint(ParsedJson.proto),\n  dst_port = toint(ParsedJson.dst_port),\n  flow_count = toint(ParsedJson['count']),\n  dir = tostring(ParsedJson.dir),    \n  dst_hostname = tostring(ParsedJson.dst_hostname),\n  network = tostring(ParsedJson.network),\n  org_id = toint(ParsedJson.org_id),\n  state = tostring(ParsedJson.state),\n  pd_qualifier = toint(ParsedJson.pd_qualifier),\n  pd = toint(ParsedJson.pd),\n  src_hostname = tostring(ParsedJson.src_hostname),    \n  src_href = tostring(ParsedJson.src_href),\n  dst_href = tostring(ParsedJson.dst_href),\n  src_labels = todynamic(ParsedJson.src_labels),\n  dst_labels = todynamic(ParsedJson.dst_labels),\n  interval_sec = toint(ParsedJson.interval_sec),\n  pce_fqdn = tostring(ParsedJson.pce_fqdn),\n  version = toint(ParsedJson.version),\n  Type = 'Illumio Syslog Network Traffic Events'\n",
                "functionParameters": "",
                "version": 2,
                "tags": [
                  {
                    "name": "description",
                    "value": ""
                  }
                ]
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "apiVersion": "2022-01-01-preview",
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject2')._parserId2,'/'))))]",
              "dependsOn": [
                "[variables('parserObject2')._parserId2]"
              ],
              "properties": {
                "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogNetworkTrafficEvents')]",
                "contentId": "[variables('parserObject2').parserContentId2]",
                "kind": "Parser",
                "version": "[variables('parserObject2').parserVersion2]",
                "source": {
                  "name": "IllumioSaaS",
                  "kind": "Solution",
                  "sourceId": "[variables('_solutionId')]"
                },
                "author": {
                  "name": "app-integrations@illumio.com"
                },
                "support": {
                  "name": "Illumio",
                  "email": "app-integrations@illumio.com",
                  "tier": "Partner",
                  "link": "https://www.illumio.com/support/support"
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "contentId": "[variables('parserObject2').parserContentId2]",
        "contentKind": "Parser",
        "displayName": "Parser for Illumio Syslog Network Traffic Events",
        "contentProductId": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject2').parserContentId2,'-', '1.0.0')))]",
        "id": "[concat(take(variables('_solutionId'),50),'-','pr','-', uniqueString(concat(variables('_solutionId'),'-','Parser','-',variables('parserObject2').parserContentId2,'-', '1.0.0')))]",
        "version": "[variables('parserObject2').parserVersion2]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2022-10-01",
      "name": "[variables('parserObject2')._parserName2]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "eTag": "*",
        "displayName": "Parser for Illumio Syslog Network Traffic Events",
        "category": "Microsoft Sentinel Parser",
        "functionAlias": "IllumioSyslogNetworkTrafficEvents",
        "query": "Syslog\n| where SyslogMessage has 'illumio_pce/collector'\n| extend JsonPayload = extract(@\"\\{.*\\}\", 0, SyslogMessage)\n| where isnotempty(JsonPayload)\n| extend ParsedJson = parse_json(JsonPayload)\n| project\n  TimeGenerated = todatetime(ParsedJson.timestamp),\n  tdms = toint(ParsedJson.tdms),\n  ddms = toint(ParsedJson.ddms),\n  pn = tostring(ParsedJson.pn),\n  un = tostring(ParsedJson.un),\n  src_ip = tostring(ParsedJson.src_ip),\n  dst_ip = tostring(ParsedJson.dst_ip),\n  class = tostring(ParsedJson.class),\n  proto = toint(ParsedJson.proto),\n  dst_port = toint(ParsedJson.dst_port),\n  flow_count = toint(ParsedJson['count']),\n  dir = tostring(ParsedJson.dir),    \n  dst_hostname = tostring(ParsedJson.dst_hostname),\n  network = tostring(ParsedJson.network),\n  org_id = toint(ParsedJson.org_id),\n  state = tostring(ParsedJson.state),\n  pd_qualifier = toint(ParsedJson.pd_qualifier),\n  pd = toint(ParsedJson.pd),\n  src_hostname = tostring(ParsedJson.src_hostname),    \n  src_href = tostring(ParsedJson.src_href),\n  dst_href = tostring(ParsedJson.dst_href),\n  src_labels = todynamic(ParsedJson.src_labels),\n  dst_labels = todynamic(ParsedJson.dst_labels),\n  interval_sec = toint(ParsedJson.interval_sec),\n  pce_fqdn = tostring(ParsedJson.pce_fqdn),\n  version = toint(ParsedJson.version),\n  Type = 'Illumio Syslog Network Traffic Events'\n",
        "functionParameters": "",
        "version": 2,
        "tags": [
          {
            "name": "description",
            "value": ""
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2022-01-01-preview",
      "location": "[parameters('workspace-location')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('Parser-', last(split(variables('parserObject2')._parserId2,'/'))))]",
      "dependsOn": [
        "[variables('parserObject2')._parserId2]"
      ],
      "properties": {
        "parentId": "[resourceId('Microsoft.OperationalInsights/workspaces/savedSearches', parameters('workspace'), 'IllumioSyslogNetworkTrafficEvents')]",
        "contentId": "[variables('parserObject2').parserContentId2]",
        "kind": "Parser",
        "version": "[variables('parserObject2').parserVersion2]",
        "source": {
          "kind": "Solution",
          "name": "IllumioSaaS",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "app-integrations@illumio.com"
        },
        "support": {
          "name": "Illumio",
          "email": "app-integrations@illumio.com",
          "tier": "Partner",
          "link": "https://www.illumio.com/support/support"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.4.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "IllumioSaaS",
        "publisherDisplayName": "Illumio",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/IllumioSaaS/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p><a href=\"https://www.illumio.com/\">IllumioSaaS</a> solution provides ability to ingest auditable and flow events from AWS S3 bucket.</p>\n<p><strong>Data Connectors:</strong> 2, <strong>Parsers:</strong> 2, <strong>Analytic Rules:</strong> 6, <strong>Function Apps:</strong> 1, <strong>Playbooks:</strong> 3</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<img src=\"https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Logos/IllumioLogo.svg\" width=\"75px\" height=\"75px\">",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "IllumioSaaS",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "app-integrations@illumio.com"
        },
        "support": {
          "name": "Illumio",
          "email": "app-integrations@illumio.com",
          "tier": "Partner",
          "link": "https://www.illumio.com/support/support"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentId2')]",
              "version": "[variables('dataConnectorVersion2')]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject1')._analyticRulecontentId1]",
              "version": "[variables('analyticRuleObject1').analyticRuleVersion1]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject2')._analyticRulecontentId2]",
              "version": "[variables('analyticRuleObject2').analyticRuleVersion2]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject3')._analyticRulecontentId3]",
              "version": "[variables('analyticRuleObject3').analyticRuleVersion3]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject4')._analyticRulecontentId4]",
              "version": "[variables('analyticRuleObject4').analyticRuleVersion4]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject5')._analyticRulecontentId5]",
              "version": "[variables('analyticRuleObject5').analyticRuleVersion5]"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('analyticRuleObject6')._analyticRulecontentId6]",
              "version": "[variables('analyticRuleObject6').analyticRuleVersion6]"
            },
            {
              "kind": "AzureFunction",
              "contentId": "[variables('_IllumioSaaS_FunctionAppConnector')]",
              "version": "[variables('playbookVersion1')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Illumio-Get-Ven-Details')]",
              "version": "[variables('playbookVersion2')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Illumio-Port-Blocking-Switch')]",
              "version": "[variables('playbookVersion3')]"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Illumio-Quarantine-Workload')]",
              "version": "[variables('playbookVersion4')]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('parserObject1').parserContentId1]",
              "version": "[variables('parserObject1').parserVersion1]"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('parserObject2').parserContentId2]",
              "version": "[variables('parserObject2').parserVersion2]"
            }
          ]
        },
        "firstPublishDate": "2024-05-13",
        "providers": [
          "Illumio"
        ],
        "categories": {
          "domains": [
            "Security - Network",
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
