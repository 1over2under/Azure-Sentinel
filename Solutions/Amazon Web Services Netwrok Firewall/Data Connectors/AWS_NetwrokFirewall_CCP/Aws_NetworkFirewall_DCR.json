[
	{
		"name": "AWSNetworkFirewall_DCR",
		"apiVersion": "2021-09-01-preview",
		"type": "Microsoft.Insights/dataCollectionRules",
		"location": "{{location}}",
		"kind": null,
		"properties": {
			"dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
			"streamDeclarations": {
                "Custom-AWSNetworkFirewall": {
                    "columns": [
                        {
							"name": "TimeGenerated",
							"type": "datetime"
						  },
						  {
							"name": "firewall_name",
							"type": "string"
						  },
						  {
							"name": "availability_zone",
							"type": "string"
						  },
						  {
							"name": "event_timestamp",
							"type": "string"
						  },
						  {
							"name": "event",
							"type": "string"
						  }
					]
				}
			},
			"destinations": {
				"logAnalytics": [
					{
						"workspaceResourceId": "{{workspaceResourceId}}",
						"name": "clv2ws1"
					}
				]
			},
			"dataFlows": [
				{
					"streams": [
						"Custom-AWSNetworkFirewall"
					],
					"destinations": [
						"clv2ws1"
					],
					"transformKql": "source | extend TimeGenerated = now() | extend Event = parse_json(event) | extend FirewallName = firewall_name, EventTimestamp = event_timestamp, Availabilityzone = availability_zone, TCPFlags = tostring(event.tcp.tcp_flags), ApplicationProtocol = tostring(event.app_proto), SourceIP = tostring(event.src_ip), SourcePort = tostring(event.src_port), NetFlowPackets = tostring(event.netflow.pkts), NetFlowBytes = tostring(event.netflow.bytes), NetFlowStartTime = tostring(event.netflow.start), NetFlowEndTime = tostring(event.netflow.end), NetFlowAge = tostring(event.netflow.age), NetFlowMinttl = tostring(event.netflow.min_ttl), NetFlowMaxttl = tostring(event.netflow.max_ttl), EventType = tostring(event.event_type), FlowId = tostring(event.flow_id), DestinationIp = tostring(event.dest_ip), DestinationPort = tostring(event.dest_port), Protocol = tostring(event.proto) | project-away Event, availability_zone, firewall_name,event",
                    "outputStream": "AWSNetworkFirewall_FlowLogV2_CL"
				},
				{
					"streams": [
						"Custom-AWSNetworkFirewall"
					],
					"destinations": [
						"clv2ws1"
					],
					"transformKql": "source | extend TimeGenerated = now(), | extend Event = parse_json(event), FirewallName = firewall_name, AvailabilityZone = availability_zone, EventTimestamp = event_timestamp, TxId = toint(Event.tx_id), ApplicationProtocol = tostring(Event.app_proto), SourceIP = tostring(Event.src_ip), SourcePort = toint(Event.src_port), EventType = tostring(Event.event_type), AlertSeverity = toint(Event.alert.severity), AlertSignatureId = toint(Event.alert.signature_id), AlertRev = toint(Event.alert.rev), AlertSignature = tostring(Event.alert.signature), AlertAction = tostring(Event.alert.action), AlertCategory = tostring(Event.alert.category), FlowId = tolong(Event.flow_id), DestinationIP = tostring(Event.dest_ip), DestinationPort = toint(Event.dest_port), Protocol = tostring(Event.proto), VerdictAction = tostring(Event.verdict.action), TLS_SNI = tostring(Event.tls.sni), TLSVersion = tostring(Event.tls.version), PacketSource = tostring(Event.pkt_src), EventDirection = tostring(Event.direction) | project-away Event",
                    "outputStream": "AWSNetworkFirewall_AlertLogV2_CL"
				}
			]
			
		}
	}
]