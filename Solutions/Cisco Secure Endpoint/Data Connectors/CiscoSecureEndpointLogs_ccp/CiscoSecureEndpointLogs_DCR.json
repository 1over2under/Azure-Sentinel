[
    {
        "name": "CiscoSecureEndpointDCR",
        "apiVersion": "2021-09-01-preview",
        "type": "Microsoft.Insights/dataCollectionRules",
        "location": "{{location}}",
        "properties": {
            "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
            "streamDeclarations": {
                "Custom-CiscoSecureEndpointAuditLogs": {
                    "columns": [
                        {
                            "name": "event",
                            "type": "string"
                        },
                        {
                            "name": "audit_log_type",
                            "type": "string"
                        },
                        {
                            "name": "audit_log_id",
                            "type": "string"
                        },
                        {
                            "name": "audit_log_user",
                            "type": "string"
                        },
                        {
                            "name": "created_at",
                            "type": "datetime"
                        },
                        {
                            "name": "item",
                            "type": "string"
                        },
                        {
                            "name": "old_attributes",
                            "type": "dynamic"
                        },
                        {
                            "name": "new_attributes",
                            "type": "dynamic"
                        }
                    ]
                },
                "Custom-CiscoSecureEndpointEvents": {
                    "columns": [
                        {
                            "name": "id",
                            "type": "real"
                        },
                        {
                            "name": "timestamp",
                            "type": "real"
                        },
                        {
                            "name": "timestamp_nanoseconds",
                            "type": "real"
                        },
                        {
                            "name": "date",
                            "type": "datetime"
                        },
                        {
                            "name": "event_type",
                            "type": "string"
                        },
                        {
                            "name": "event_type_id",
                            "type": "real"
                        },
                        {
                            "name": "detection",
                            "type": "string"
                        },
                        {
                            "name": "detection_id",
                            "type": "string"
                        },
                        {
                            "name": "connector_guid",
                            "type": "string"
                        },
                        {
                            "name": "group_guids",
                            "type": "string"
                        },
                        {
                            "name": "severity",
                            "type": "string"
                        },
                        {
                            "name": "tactics",
                            "type": "string"
                        },
                        {
                            "name": "techniques",
                            "type": "string"
                        },
                        {
                            "name": "hostname",
                            "type": "string"
                        },
                        {
                            "name": "vulnerabilities",
                            "type": "string"
                        },
                        {
                            "name": "error",
                            "type": "dynamic"
                        },
                        {
                            "name": "computer",
                            "type": "dynamic"
                        },
                        {
                            "name": "file",
                            "type": "dynamic"
                        },
                        {
                            "name": "scan",
                            "type": "dynamic"
                        },
                        {
                            "name": "bp_data",
                            "type": "dynamic"
                        },
                        {
                            "name": "policy",
                            "type": "dynamic"
                        },
                        {
                            "name": "product_update",
                            "type": "dynamic"
                        },
                        {
                            "name": "isolation",
                            "type": "dynamic"
                        },
                        {
                            "name": "forensic_snapshot",
                            "type": "dynamic"
                        },
                        {
                            "name": "device_control",
                            "type": "dynamic"
                        },
                        {
                            "name": "endpoint_ioc_scan",
                            "type": "dynamic"
                        },
                        {
                            "name": "orbital",
                            "type": "dynamic"
                        },
                        {
                            "name": "command_line",
                            "type": "dynamic"
                        },
                        {
                            "name": "cloud_ioc",
                            "type": "dynamic"
                        }
                    ]
                }
            },
            "destinations": {
                "logAnalytics": [
                    {
                        "workspaceResourceId": "{{workspaceResourceId}}",
                        "name": "clv2ws1"
                    }
                ]
            },
            "dataFlows": [
                {
                    "streams": [
                        "Custom-CiscoSecureEndpointAuditLogs"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend OldAttributes = parse_json(old_attributes) | extend NewAttributes = parse_json(new_attributes) | extend Event = event, AuditLogType = audit_log_type, AuditLogId = audit_log_id, AuditLogUser = audit_log_user, TimeGenerated = created_at, Item = item, OldAttributesName = tostring(OldAttributes['name']), OldAttributesHostname = tostring(OldAttributes['hostname']), OldAttributesIpExternal = tostring(OldAttributes['ip_external']), OldAttributesOperatingSystemId = todouble(OldAttributes['operating_system_id']), OldAttributesStatusString = tostring(OldAttributes['status']), OldAttributesProductVersionId = todouble(OldAttributes['product_version_id']), OldAttributesSha = tostring(OldAttributes['sha']), OldAttributesCloudNotification = tobool(OldAttributes['cloud_notification']), OldAttributesShowToastNotifications = tobool(OldAttributes['show_toast_notifications']), OldAttributesHostFirewallMode = tostring(OldAttributes['host_firewall_mode']), OldAttributesSppMode = tostring(OldAttributes['spp_mode']), OldAttributesAmsiMode = tostring(OldAttributes['amsi_mode']), OldAttributesExploitPreventionMode = tostring(OldAttributes['exploit_prevention_mode']), OldAttributesEndpointIsolation = tobool(OldAttributes['endpoint_isolation']), OldAttributesConnectorProtection = tobool(OldAttributes['connector_protection']), OldAttributesApdeMode = tostring(OldAttributes['apde_mode']), OldAttributesStatusReal = todouble(OldAttributes['status']), OldAttributesActive = tobool(OldAttributes['active']), OldAttributesToAnalyze = tobool(OldAttributes['to_analyze']), OldAttributesState = tostring(OldAttributes['state']), OldAttributesGroups = tostring(OldAttributes['groups']), OldAttributesSeverity = tostring(OldAttributes['Severity']), OldAttributesDesc = tostring(OldAttributes['desc']), OldAttributesGroupId = todouble(OldAttributes['group_id']), OldAttributesConnectorGuid = tostring(OldAttributes['connector_guid']), OldAttributesAutoAnalysis = tobool(OldAttributes['auto_analysis']), OldAttributesFileConvictionMode = tostring(OldAttributes['file_conviction_mode']), OldAttributesDfcEnable = tobool(OldAttributes['dfc_enable']), OldAttributesOfflineEngine = tostring(OldAttributes['offline_engine']), OldAttributesScanMaxArchivesize = todouble(OldAttributes['scan_max_archivesize']), OldAttributesScanMaxFilesize = todouble(OldAttributes['scan_max_filesize']), OldAttributesDfcConvictionMode = tostring(OldAttributes['dfc_conviction_mode']), OldAttributesExploitPrevention = tobool(OldAttributes['exploit_prevention']), OldAttributesHeuristic = tobool(OldAttributes['heuristic']), OldAttributesSystemProcessProtection = tobool(OldAttributes['system_process_protection']), OldAttributesHeuristicMode = tostring(OldAttributes['heuristic_mode']), OldAttributesOrbital = tobool(OldAttributes['orbital']), OldAttributesIsolationAllowDns = tobool(OldAttributes['isolation_allow_dns']), OldAttributesIsolationAllowDhcp = tobool(OldAttributes['isolation_allow_dhcp']), OldAttributesApplicationName = tostring(OldAttributes['application_name']), OldAttributesApiClientId = tostring(OldAttributes['api_client_id']), OldAttributesScope = tostring(OldAttributes['scope']), OldAttributesCmdLineEnabled = tobool(OldAttributes['cmd_line_enabled']), OldAttributesAuditLogsFrDownloadsEnabled = tobool(OldAttributes['audit_logs_fr_downloads_enabled']), NewAttributesName = tostring(NewAttributes['name']), NewAttributesDesc = tostring(NewAttributes['desc']), NewAttributesHostname = tostring(NewAttributes['hostname']), NewAttributesIpExternal = tostring(NewAttributes['ip_external']), NewAttributesGroupId = todouble(NewAttributes['group_id']), NewAttributesOperatingSystemId = todouble(NewAttributes['operating_system_id']), NewAttributesPolicyId = todouble(NewAttributes['policy_id']), NewAttributesConnectorGuid = tostring(NewAttributes['connector_guid']), NewAttributesStatusString = tostring(NewAttributes['status']), NewAttributesProductVersionId = todouble(NewAttributes['product_version_id']), NewAttributesCloudNotification = tobool(NewAttributes['cloud_notification']), NewAttributesShowToastNotifications = tobool(NewAttributes['show_toast_notifications']), NewAttributesIsolated = tobool(NewAttributes['isolated']), NewAttributesJobId = tostring(NewAttributes['job_id']), NewAttributesComment = tostring(NewAttributes['comment']), NewAttributesUnlockCode = tostring(NewAttributes['unlock_code']), NewAttributesHostFirewallConfigurationId = todouble(NewAttributes['host_firewall_configuration_id']), NewAttributesHostFirewallMode = tostring(NewAttributes['host_firewall_mode']), NewAttributesDefaultAction = tostring(NewAttributes['default_action']), NewAttributesSppMode = tostring(NewAttributes['spp_mode']), NewAttributesScanTypeString = tostring(NewAttributes['scan_type']), NewAttributesScanOption = tostring(NewAttributes['scan_option']), NewAttributesAgentGuid = tostring(NewAttributes['agent_guid']), NewAttributesEndpointIsolation = tobool(NewAttributes['endpoint_isolation']), NewAttributesDeviceControlConfigurationId = todouble(NewAttributes['device_control_configuration_id']), NewAttributesDeviceClass = tostring(NewAttributes['device_class']), NewAttributesRulesJsonSha = tostring(NewAttributes['rules_json_sha']), NewAttributesRevision = todouble(NewAttributes['revision']), NewAttributesControlType = tostring(NewAttributes['control_type']), NewAttributesNotificationType = tostring(NewAttributes['notification_type']), NewAttributesConnectorProtection = tobool(NewAttributes['connector_protection']), NewAttributesAnalysisState = tostring(NewAttributes['analysis_state']), NewAttributesToAnalyze = tobool(NewAttributes['to_analyze']), NewAttributesState = tostring(NewAttributes['state']), NewAttributesFilesize = todouble(NewAttributes['filesize']), NewAttributesOriginalFilename = tostring(NewAttributes['original_filename']), NewAttributesGroups = tostring(NewAttributes['groups']), NewAttributesSeverity = tostring(NewAttributes['Severity']), NewAttributesScanTypeReal = todouble(NewAttributes['scan_type']), NewAttributesStatusReal = todouble(NewAttributes['status']), NewAttributesScanOptions = todouble(NewAttributes['scan_options']), NewAttributesPolicy = tostring(NewAttributes['policy']), NewAttributesScheduledFor = tostring(NewAttributes['scheduled_for']), NewAttributesShortDescription = tostring(NewAttributes['short_description']), NewAttributesXmlValid = tobool(NewAttributes['xml_valid']), NewAttributesGuid = tostring(NewAttributes['guid']), NewAttributesSha = tostring(NewAttributes['sha']), NewAttributesAutoAnalysis = tobool(NewAttributes['auto_analysis']), NewAttributesPolicies = tostring(NewAttributes['policies']), NewAttributesFileConvictionMode = tostring(NewAttributes['file.conviction_mode']), NewAttributesDfcEnable = tobool(NewAttributes['dfc_enable']), NewAttributesId = todouble(NewAttributes['id']), NewAttributesBlacklistId = todouble(NewAttributes['blacklist_id']), NewAttributesWhitelistId = todouble(NewAttributes['whitelist_id']), NewAttributesDescription = tostring(NewAttributes['description']), NewAttributesScanMaxArchivesize = todouble(NewAttributes['scan_max_archivesize']), NewAttributesScanMaxFilesize = todouble(NewAttributes['scan_max_filesize']), NewAttributesContentUpdateInterval = todouble(NewAttributes['content_update_interval']), NewAttributesOfflineEngine = tostring(NewAttributes['offline_engine']), NewAttributesDetectionThresholdPerSperoHash = todouble(NewAttributes['detection_threshold_per_spero_hash']), NewAttributesDfcConvictionMode = tostring(NewAttributes['dfc_conviction_mode']), NewAttributesDfcUnknownParentConvictionEnabled = tobool(NewAttributes['dfc_unknown_parent_conviction_enabled']), NewAttributesDfcDataUsed = tostring(NewAttributes['data_used']), NewAttributesDetectionThresholdPerEthosHash = todouble(NewAttributes['detection_threshold_per_ethos_hash']), NewAttributesStepUpThreshold = todouble(NewAttributes['step_up_threshold']), NewAttributesStepUpEnabled = tobool(NewAttributes['step_up_enabled']), NewAttributesExploitPrevention = tobool(NewAttributes['exploit_prevention']), NewAttributesHeuristic = tobool(NewAttributes['heuristic']), NewAttributesSystemProcessProtection = tobool(NewAttributes['system_process_protection']), NewAttributesHeuristicMode = tostring(NewAttributes['heuristic_mode']), NewAttributesOrbital = tobool(NewAttributes['orbital']), NewAttributesIsolationAllowDns = tobool(NewAttributes['isolation_allow_dns']), NewAttributesIsolationAllowDhcp = tobool(NewAttributes['isolation_allow_dhcp']), NewAttributesAmsiMode = tostring(NewAttributes['amsi_mode']), NewAttributesExploitPreventionMode = tostring(NewAttributes['exploit_prevention_mode']), NewAttributesApdeMode = tostring(NewAttributes['apde_mode']), NewAttributesApdeEnabled = tobool(NewAttributes['apde_enabled']), NewAttributesEtwEnabled = tobool(NewAttributes['etw_enabled']), NewAttributesExclusionSets = tostring(NewAttributes['exclusion_sets']), NewAttributesApplicationName = tostring(NewAttributes['application_name']), NewAttributesApiClientId = tostring(NewAttributes['api_client_id']), NewAttributesScope = tostring(NewAttributes['scope']), NewAttributesCmdLineEnabled = tobool(NewAttributes['cmd_line_enabled']), NewAttributesAuditLogsFrDownloadsEnabled = tobool(NewAttributes['audit_logs_fr_downloads_enabled']), NewAttributesActiveBoolean = tobool(NewAttributes['active']), NewAttributesActiveReal = todouble(NewAttributes['active']) | project-away old_attributes, new_attributes",
                    "outputStream": "Custom-CiscoSecureEndpointAuditLogsV2_CL"
                },
                {
                    "streams": [
                        "Custom-CiscoSecureEndpointEvents"
                    ],
                    "destinations": [
                        "clv2ws1"
                    ],
                    "transformKql": "source | extend Error = parse_json(error) | extend Computer = parse_json(computer) | extend File = parse_json(file) | extend Scan = parse_json(scan) | extend BpData = parse_json(bp_data) | extend Policy = parse_json(policy) | extend ProductUpdate = parse_json(product_update) | extend Isolation = parse_json(isolation) | extend ForensicSnapshot = parse_json(forensic_snapshot) | extend DeviceControl = parse_json(device_control) | extend EndpointIocScan = parse_json(endpoint_ioc_scan) | extend Orbital = parse_json(orbital) | extend CommandLine = parse_json(command_line) | extend CloudIoc = parse_json(cloud_ioc) | extend Id = id, Timestamp = timestamp, TimestampNanoseconds = timestamp_nanoseconds, TimeGenerated = ['date'], EventType = event_type, EventTypeId = event_type_id, Detection = detection, DetectionId = detection_id, ConnectorGuid = connector_guid, GroupGuids = group_guids, Severity = severity, Tactics = tactics, Techniques = techniques, Hostname = hostname, Vulnerabilities = vulnerabilities, ErrorErrorCode = todouble(Error['error_code']), ErrorDescription = tostring(Error['description']), ComputerConnectorGuid = tostring(Computer['connector_guid']), ComputerHostname = tostring(Computer['hostname']), ComputerExternalIp = tostring(Computer['external_ip']), ComputerUser = tostring(Computer['user']), ComputerActive = tobool(Computer['active']), ComputerNetworkAddresses = tostring(Computer['network_addresses']), ComputerLinksComputer = tostring(Computer['links']['computer']), ComputerLinksTrajectory = tostring(Computer['links']['trajectory']), ComputerLinksGroup = tostring(Computer['links']['group']), FileDisposition = tostring(File['disposition']), FileFileName = tostring(File['file_name']), FileFilePath = tostring(File['file_path']), FileIdentitySha256 = tostring(File['identity']['sha256']), FileIdentitySha1 = tostring(File['identity']['sha1']), FileIdentityMd5 = tostring(File['identity']['md5']), FileParentProcessId = todouble(File['parent']['process_id']), FileParentDisposition = tostring(File['parent']['disposition']), FileParentFileName = tostring(File['parent']['file_name']), FileParentIdentitySha256 = tostring(File['parent']['identity']['sha256']), FileParentIdentitySha1 = tostring(File['parent']['identity']['sha1']), FileParentIdentityMd5 = tostring(File['parent']['identity']['md5']), FileAttackDetailsApplication = tostring(File['attack_details']['application']), FileAttackDetailsAttackedModule = tostring(File['attack_details']['attacked_module']), FileAttackDetailsBaseAddress = tostring(File['attack_details']['base_address']), FileAttackDetailsSuspiciousFiles = tostring(File['attack_details']['suspicious_files']), ScanDescription = tostring(Scan['description']), ScanClean = tobool(Scan['clean']), ScanScannedFiles = todouble(Scan['scanned_files']), ScanScannedProcesses = todouble(Scan['scanned_processes']), ScanScannedPaths = todouble(Scan['scanned_paths']), ScanMaliciousDetections = todouble(Scan['malicious_detections']), BpDataPackageManagerPendingVersion = todouble(BpData['package_manager_pending_version']), BpDataPackageManagerSerialNumber = todouble(BpData['package_manager_serial_number']), BpDataSts = todouble(BpData['sts']), BpDataPackageName = tostring(BpData['package_name']), BpDataPackageManagerCurrentVersion = todouble(BpData['package_manager_current_version']), BpDataNormalizedSeverityId = todouble(BpData['normalized']['severity_id ']), PolicySerialNumber = todouble(Policy['serial_number']), ProductUpdateCurrentVersion = tostring(ProductUpdate['current_version']), ProductUpdateUpdateVersion = tostring(ProductUpdate['update_version']), IsolationDuration = todouble(Isolation['duration']), IsolationUser = tostring(Isolation['user']), ForensicSnapshotUrl = tostring(ForensicSnapshot['url']), DeviceControlDataPackageManagerSerialNumber = tostring(DeviceControl['data']['package_manager_serial_number']), DeviceControlDataPackageName = tostring(DeviceControl['data']['package_name']), DeviceControlDataSts = todouble(DeviceControl['data']['sts']), DeviceControlDataNormalizedSeverityId = todouble(DeviceControl['data']['normalized']['severity_id']), EndpointIocScanClean = tobool(EndpointIocScan['clean']), EndpointIocScanDescription = tostring(EndpointIocScan['description']), EndpointIocScanScannedObjects = todouble(EndpointIocScan['scanned_objects']), EndpointIocScanMatchedObjects = todouble(EndpointIocScan['matched_objects']), EndpointIocScanMaliciousDetections = todouble(EndpointIocScan['malicious_detections']), OrbitalVersion = tostring(Orbital['version']), OrbitalOldVersion = tostring(Orbital['old_version']), CommandLineArguments = tostring(CommandLine['arguments']), CloudIocDescription = tostring(CloudIoc['description']), CloudIocShortDescription = tostring(CloudIoc['short_description']) | project-away error, computer, file, scan, bp_data, policy, product_update, isolation, forensic_snapshot, device_control, endpoint_ioc_scan, orbital, command_line, cloud_ioc",
                    "outputStream": "Custom-CiscoSecureEndpointEventsV2_CL"
                }
            ]
        }
    }
]