id: 7d7a3d3f-22db-4cdf-ba67-c57215777a3c
name: Top 10 Users clicking on Malicious URLs (Malware+Phish+Spam)
description: |
  Identifies users with the highest click counts on URLs classified as malware, phishing, or spam.
description-detailed: |
  This query summarizes malicious URL click events across all threat types (malware, phishing, spam) to identify high-risk users. 
  By default limited to top 10 users; adjust or remove the limit for full results. Part of the Defender for Office 365 solution.
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
    - UrlClickEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  let TimeStart = startofday(ago(30d));
  let TimeEnd = startofday(now());
  UrlClickEvents
  | where Timestamp between (TimeStart .. TimeEnd)
  | where ThreatTypes has_any ("Malware", "Phish", "Spam")
  //| where ActionType != "ClickSimulated"  // Uncomment to exclude phishing simulations
  | summarize ClickCount = count() by User = AccountUpn
  | sort by ClickCount desc
  | top 10 by ClickCount  // Uncomment to limit to top 10; remove to see all
  //| render columnchart  // Compare users
  //| render piechart  // Proportional breakdown
version: 1.0.0
