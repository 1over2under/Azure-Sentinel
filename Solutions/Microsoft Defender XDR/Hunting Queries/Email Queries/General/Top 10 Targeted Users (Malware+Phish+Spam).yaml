id: 504814de-581d-4f8b-8f4b-95a24d188e22
name: Top 10 Targeted Users (Malware+Phish+Spam)
description: |
  Identifies the top 10 users receiving emails with malware, phishing, or spam threats.
description-detailed: |
  This query identifies the top 10 users targeted by malicious emails (malware, phishing, or spam) based on inbound email events.
  By default, results are limited to the top 10 users; remove or adjust the limit to see all results.
  Part of the Defender for Office 365 solution in Sentinel: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
    - EmailEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  let TimeStart = startofday(ago(30d));
  let TimeEnd = startofday(now());
  EmailEvents
  | where Timestamp between (TimeStart .. TimeEnd)
  | where EmailDirection == "Inbound"
  | where ThreatTypes has_any ("Malware", "Phish", "Spam")
  //| where OrgLevelPolicy != "Phishing simulation" and OrgLevelPolicy != "SecOps Mailbox"  // Uncomment to exclude simulations/SecOps
  | summarize TargetedCount = count() by User = RecipientEmailAddress
  | sort by TargetedCount desc
  | top 10 by TargetedCount  // Uncomment to limit to top 10 users; remove to see all
  //| render columnchart  // Compare users
  //| render piechart  // Proportional breakdown
version: 1.0.0
