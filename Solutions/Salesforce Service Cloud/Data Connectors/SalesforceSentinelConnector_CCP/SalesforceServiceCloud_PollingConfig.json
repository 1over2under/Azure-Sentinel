[
  {
    "name": "SalesforceServiceCloudPolling",
    "apiVersion": "2022-12-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "location": "{{location}}",
    "kind": "RestApiPoller",
    "properties": {
      "connectorDefinitionName": "SalesForceServiceCloudCCPDefinition",
      "dataType": "SalesforceServiceCloud_CL",
      "dcrConfig": {
        "dataCollectionEndpoint": "{{dataCollectionEndpoint}}",
        "dataCollectionRuleImmutableId": "{{dataCollectionRuleImmutableId}}",
        "streamName": "Custom-SalesforceServiceCloud_CL"
      },
      "auth": {
        "type": "OAuth2",
        "ClientSecret": "{{clientSecret}}",
        "ClientId": "{{clientId}}",
        "TokenEndpoint": "{{salesforceDomainName}}/services/oauth2/token",
        "tokenEndpointHeaders": {
          "Accept": "application/json",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        "TokenEndpointQueryParameters": {},
        "grantType": "client_credentials"
      },
      "request": {
        "apiEndpoint": "{{salesforceDomainName}}/services/data/v44.0/query",
        "httpMethod": "GET",
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "rateLimitQPS": 10,
        "queryWindowInMin": 10,
        "retryCount": 3,
        "timeoutInSeconds": 60,
        "headers": {
          "Accept": "application/json",
          "User-Agent": "Scuba"
        },
        "queryParameters": {
          "q": "SELECT Id,EventType,LogDate,CreatedDate,LogFile,LogFileLength FROM EventLogFile WHERE CreatedDate>{_QueryWindowStartTime} and CreatedDate<{_QueryWindowEndTime}"
        }
      },
      "paging": {
        "pagingType": "NextPageUrl",
        "nextPageTokenJsonPath": "$.nextRecordsUrl",
        "hasNextFlagJsonPath": "$.done",
        "nextPageUrl": "{{salesforceDomainName}}"
      },
      "response": {
        "eventsJsonPaths": ["$.records"],
        "format": "json",
        "SuccessStatusJsonPath": "$.done",
        "SuccessStatusValue": "true"
      },
      "stepInfo": {
        "stepType": "Nested",
        "nextSteps": [
          {
            "stepId": "fetchLogFileData",
            "stepPlaceholdersParsingKql": "source | project res = parse_json(data) | project logFileUrl = res.LogFile"
          }
        ]
      },
      "stepCollectorConfigs": {
        "fetchLogFileData": {
          "shouldJoinNestedData": true,
          "joinedDataStepName": "LogData",
          "request": {
            "httpMethod": "GET",
            "apiEndpoint": "{{salesforceDomainName}}$logFileUrl$",
            "headers": {
              "Accept": "application/json",
              "User-Agent": "Scuba"
            }
          },
          "response": {
            "format": "csv",
            "eventsJsonPaths": [ "$" ],
            "HasCsvHeader": true
          }
        }
      }
    }
  }
]
