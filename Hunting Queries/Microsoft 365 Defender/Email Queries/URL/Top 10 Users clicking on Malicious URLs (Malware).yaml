id: 5a84e13a-bb17-4124-9564-d74cdb84c124
name: Top 10 Users clicking on Malicious URLs (Malware)
description: |
  Identifies the top 10 users who have clicked on URLs classified as malware, helping prioritize user awareness and response.
description-detailed: |
  This query identifies the top 10 users who have clicked on URLs detected as malware by Safe Links or other Defender for Office 365 protections.
  By default, results are limited to the top 10 users with the highest click counts for malware URLs; you can remove or adjust this limit to see all users.
  Part of the Defender for Office 365 solution in Sentinel: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
    - UrlClickEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  let TimeStart = startofday(ago(30d));
  let TimeEnd = startofday(now());
  UrlClickEvents
  | where Timestamp between (TimeStart .. TimeEnd)
  | where ThreatTypes has "Malware"
  | summarize MalwareClicks = count() by User = AccountUpn
  | sort by MalwareClicks desc
  | top 10 by MalwareClicks  // Uncomment to limit to top 10 users; remove to see all results
  //| render columnchart // Uncomment to visualize as a column chart
  //| render piechart // Uncomment to visualize as a pie chart
version: 1.0.0
