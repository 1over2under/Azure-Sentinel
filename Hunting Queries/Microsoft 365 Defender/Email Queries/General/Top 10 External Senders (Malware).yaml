id: 530ef5e4-7ee4-4d70-a8e2-a06459605c02
name: Top 10 External Senders (Malware)
description: |
  Identifies the top 10 external senders of malware-detected emails.
  Important: Replace REPLACEWITHYOURDOMAININQUOTES with your domain in quotes, e.g., "contoso.com".
  Note: No hardcoded time filter. Relies on portal UI time picker.
  Based on concepts from the Defender for Office 365 solution in Sentinel: https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/part-2-build-custom-email-security-reports-and-dashboards-with-workbooks-in-micr/4411303
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - EmailEvents
tactics:
  - InitialAccess
relevantTechniques:
  - T1566
query: |
  EmailEvents
  | where EmailDirection == "Inbound" and ThreatTypes has "Malware"
  | extend SenderFromDomain = tostring(split(SenderFromAddress, "@")[1])
  // Replace the placeholder below with your domain in quotes, e.g., "contoso.com"
  | where SenderFromDomain !endswith REPLACEWITHYOURDOMAININQUOTES
  | summarize (Timestamp, ReportId) = arg_max(Timestamp, ReportId), Count = count() by SenderFromAddress
  | sort by Count desc
  | take 10
version: 1.0.0